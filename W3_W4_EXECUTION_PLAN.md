# Stage 2 - W3-W4 执行计划 (2月3日-2月16日)

**版本**: v1.0  
**日期**: 2026-01-20  
**阶段**: Stage 2 执行 - 核心开发与优化  
**涵盖**: 第三周与第四周的完整执行框架

---

## 📋 目录

1. [概述与目标](#概述与目标)
2. [W3 详细计划](#w3-详细计划)
3. [W4 详细计划](#w4-详细计划)
4. [跨周协调](#跨周协调)
5. [风险与缓解](#风险与缓解)

---

## 概述与目标

### W1-W4 整体框架

```
W1 (1月20-26日): 架构设计 ✅ 完成
   └─ 5 份架构与规范文档 (55.6K 字)

W2 (1月27-2月2日): 编码启动 🚀 进行中
   └─ 5 份执行与实现文档 (14K 字)
   └─ 代码框架初始化 (420+ LOC 目标)

W3 (2月3-9日): 核心开发 📅 本周计划
   └─ 功能完整实现
   └─ 550+ LOC 代码产出
   └─ 流量控制与优化

W4 (2月10-16日): 集成与验证 📅 本周计划
   └─ 硬件原理图完成
   └─ 完整测试与基准
   └─ 周度总结与 M2.1 准备
```

### W3-W4 核心目标

```
📊 代码开发:
├─ W3 目标: 550+ 新代码行 (PTP 250+, TSN 250+, HW 硬件设计)
├─ W4 目标: 200+ 优化与测试代码 (性能提升 + 覆盖率提升)
└─ 累计: 1200+ 代码行 (W2 + W3 + W4 合计)

🧪 测试质量:
├─ W3 目标: 55%+ 单元测试覆盖率
├─ W4 目标: 70%+ 单元测试覆盖率
└─ 集成测试: PTP + TSN 联合验证

🏗️ 硬件设计:
├─ W3 目标: 原理图 75% 完成
├─ W4 目标: PCB 设计 100%, 生成 Gerber 文件
└─ 成本验证: 保持 ¥350-400

📈 性能指标:
├─ PTP 延迟: <50µs (W3), <20µs (W4 目标)
├─ TSN 延迟: <500µs (W3), <100µs (W4 目标)
└─ 系统集成: 通过联合测试
```

---

## W3 详细计划 (2月3日-9日)

### 周日程总览

```
周一 (2月3日)      周二-周四 (2月4-6日)    周五 (2月7日)
├─ 10:00 站会     ├─ 集中开发             ├─ 10:00 周度评审
├─ 14:00 技术分享  ├─ 代码集成             ├─ 14:00 代码审查
└─ 准备启动       └─ 性能优化             └─ 进度总结

重点: PTP + TSN + HW 三条线并行推进
```

### PTP Master 核心功能完成 (250+ LOC)

```
目标: 完整的 SYNC/FOLLOW_UP/DELAY_REQ/RESP 流程

任务分解:

1️⃣ SYNC 消息处理 (100 LOC)
   ├─ SYNC 消息生成与发送 (30 LOC)
   ├─ 时间戳采集与管理 (30 LOC)
   ├─ FOLLOW_UP 构造与发送 (20 LOC)
   ├─ 单元测试 (20 LOC)
   └─ 预期完成: 2月4日

2️⃣ DELAY_REQ/RESP 处理 (80 LOC)
   ├─ DELAY_REQ 接收与处理 (20 LOC)
   ├─ DELAY_RESP 生成与发送 (20 LOC)
   ├─ 延迟计算与补偿 (20 LOC)
   ├─ 单元测试 (20 LOC)
   └─ 预期完成: 2月5日

3️⃣ 定时管理与同步 (50 LOC)
   ├─ 1Hz ANNOUNCE 周期实现 (15 LOC)
   ├─ 16s SYNC 周期实现 (15 LOC)
   ├─ 时间同步与检验 (10 LOC)
   ├─ 故障恢复机制 (10 LOC)
   └─ 预期完成: 2月6日

4️⃣ 集成测试与优化 (20 LOC)
   ├─ PTP Master 集成测试 (10 LOC)
   ├─ 性能基准测试 (5 LOC)
   ├─ 代码审查修正 (5 LOC)
   └─ 预期完成: 2月7日

期望成果:
├─ 代码行数: 250+ 新增
├─ 测试覆盖率: 60%+ (从 40% 提升)
├─ 关键路径: SYNC → FOLLOW_UP → DELAY 完整
└─ 性能: <50µs 延迟 (可测量)
```

### TSN 调度器算法完成 (250+ LOC)

```
目标: 完整的流量分类、带宽控制、Linux 集成

任务分解:

1️⃣ 流量分类与优先级 (70 LOC)
   ├─ 流识别规则实现 (25 LOC)
   ├─ 优先级映射表 (15 LOC)
   ├─ 动态优先级更新 (15 LOC)
   ├─ 单元测试 (15 LOC)
   └─ 预期完成: 2月4日

2️⃣ 带宽预留与控制 (80 LOC)
   ├─ 入场控制算法 (25 LOC)
   ├─ 带宽监测与反馈 (25 LOC)
   ├─ 流表管理 (20 LOC)
   ├─ 单元测试 (10 LOC)
   └─ 预期完成: 2月5日

3️⃣ Linux tc/taprio 集成 (60 LOC)
   ├─ taprio 接口实现 (30 LOC)
   ├─ 配置与命令生成 (20 LOC)
   ├─ 集成测试 (10 LOC)
   └─ 预期完成: 2月6日

4️⃣ 性能测试与优化 (40 LOC)
   ├─ 延迟测试工具 (15 LOC)
   ├─ 吞吐量验证 (10 LOC)
   ├─ 算法优化 (10 LOC)
   ├─ 文档更新 (5 LOC)
   └─ 预期完成: 2月7日

期望成果:
├─ 代码行数: 250+ 新增
├─ 测试覆盖率: 60%+ (从 40% 提升)
├─ Linux 兼容性: taprio 成功集成
└─ 性能: <500µs 延迟 (可测量)
```

### 硬件设计推进 (原理图 75%)

```
目标: 完成网络、PTP 硬件时间戳、扩展接口设计

任务分解:

1️⃣ 网络接口完成 (Sheet 3, 100%)
   ├─ RTL8211FD PHY 配置 (2月4日)
   ├─ RJ45 连接器与变压器 (2月4日)
   ├─ 时钟输出 (2月5日)
   └─ 审查与修正 (2月5日)

2️⃣ PTP 硬件时间戳 (新 Sheet, 100%)
   ├─ 时间戳捕获电路 (2月5日)
   ├─ GPIO 时钟输出 (2月6日)
   ├─ 温度补偿 (可选, 2月6日)
   └─ 审查与修正 (2月6日)

3️⃣ 扩展接口 (Sheet 5, 80%)
   ├─ USB 3.0 Hub 接口 (2月6日)
   ├─ GPIO 扩展头 (2月6日)
   ├─ UART 调试接口 (2月7日)
   └─ 初步审查 (2月7日)

4️⃣ 监控与保护 (Sheet 6, 50%)
   ├─ 温度监控 (可选, 2月7日)
   ├─ 电源监控 (可选, 2月7日)
   └─ EMI 过滤 (持续, 2月7日)

期望成果:
├─ 原理图完成度: 75%
├─ 关键路径完整: 电源 + 处理器 + 网络 + PTP 时间戳
├─ PCB 预准备: 可开始初步布局
└─ 成本验证: ¥350 保持
```

### W3 周度评审 (2月7日 10:00-12:00)

```
议程:

1️⃣ PTP 进度报告 (25min)
   ├─ 代码行数: 250+ (实际)
   ├─ 测试覆盖率: 60%+ (实际)
   ├─ SYNC/DELAY 流程演示
   ├─ 性能数据 (<50µs?)
   └─ 发现的问题 & 解决方案

2️⃣ TSN 进度报告 (25min)
   ├─ 代码行数: 250+ (实际)
   ├─ 测试覆盖率: 60%+ (实际)
   ├─ Linux 集成状态
   ├─ 性能数据 (<500µs?)
   └─ 发现的问题 & 解决方案

3️⃣ 硬件进度报告 (20min)
   ├─ 原理图完成度: 75% (实际)
   ├─ 关键电路验证
   ├─ PCB 初步布局
   └─ 下周计划 (PCB 设计 80%)

4️⃣ 跨系统集成讨论 (15min)
   ├─ PTP + TSN 联合测试计划
   ├─ 硬件集成准备
   ├─ 性能基准测试
   └─ W4 重点确认
```

---

## W4 详细计划 (2月10日-16日)

### 周日程总览

```
周一 (2月10日)      周二-周四 (2月11-13日)   周五 (2月14日)
├─ 10:00 站会     ├─ PCB 设计完成           ├─ 10:00 周度评审
├─ 性能优化启动    ├─ 集成测试启动           ├─ 14:00 M2.1 准备会
└─ 最终代码冲刺    └─ 基准测试跑全套         └─ 月度总结

重点: 冲刺完成、集成验证、M2.1 准备
```

### PTP Master 性能优化 & 完善 (100 LOC)

```
目标: 从 <50µs 优化到 <20µs 延迟, 80%+ 覆盖率

任务:

1️⃣ 性能优化 (50 LOC)
   ├─ 消息处理优化 (15 LOC)
   ├─ 时间戳精度提升 (15 LOC)
   ├─ 缓冲管理优化 (10 LOC)
   ├─ 基准测试 (10 LOC)
   └─ 预期完成: 2月11-12日

2️⃣ 完善与测试 (50 LOC)
   ├─ 边界条件处理 (15 LOC)
   ├─ 错误处理 (10 LOC)
   ├─ 集成测试 (15 LOC)
   ├─ 文档补充 (10 LOC)
   └─ 预期完成: 2月13-14日

期望成果:
├─ 性能: <20µs 延迟 (达成目标)
├─ 覆盖率: 80%+ 单元测试
├─ 稳定性: 24h 运行无错误
└─ 文档: 完整的 API 文档 + 使用指南
```

### TSN 调度器完整验证 & 优化 (100 LOC)

```
目标: 从 <500µs 优化到 <100µs 延迟, 80%+ 覆盖率

任务:

1️⃣ 算法优化 (50 LOC)
   ├─ 流量分类快速路径 (15 LOC)
   ├─ 带宽计算优化 (15 LOC)
   ├─ 门控时序优化 (10 LOC)
   ├─ 基准测试 (10 LOC)
   └─ 预期完成: 2月11-12日

2️⃣ 完整集成 (50 LOC)
   ├─ Linux 驱动集成 (20 LOC)
   ├─ Python API 完善 (15 LOC)
   ├─ 集成测试套件 (10 LOC)
   ├─ 文档更新 (5 LOC)
   └─ 预期完成: 2月13-14日

期望成果:
├─ 性能: <100µs 延迟 (达成目标)
├─ 覆盖率: 80%+ 单元测试
├─ Linux: 与 tc/taprio 完整集成
└─ 文档: 完整的使用手册 + API 文档
```

### 硬件设计冲刺完成 & PCB 设计 (原理图 100%, PCB 100%)

```
目标: 原理图完成, PCB 设计完成, 生成 Gerber 文件

任务:

1️⃣ 原理图最后 25% (2月10-11日)
   ├─ Sheet 6 监控电路完成 (2月10日)
   ├─ 全部原理图检查 (2月11日)
   ├─ DFM 规则检查 (2月11日)
   └─ 生成原理图 PDF (2月11日)

2️⃣ PCB 布局与设计 (2月11-13日)
   ├─ 元器件自动放置 (2月11日)
   ├─ 手工调整优化 (2月12日)
   │  ├─ 信号完整性
   │  ├─ 电源分配
   │  └─ 热管理
   ├─ 布线设计 (2月12-13日)
   │  ├─ 高速信号 (RGMII, PTP)
   │  ├─ 电源层设计
   │  └─ GND 平面
   └─ 规则检查 (2月13日)

3️⃣ 制造文件生成 (2月14日)
   ├─ Gerber 文件生成 (2月14日)
   ├─ 钻孔文件生成 (2月14日)
   ├─ 装配文件生成 (2月14日)
   ├─ DFM 检查提交 (2月14日)
   └─ 供应商准备 (2月14日)

期望成果:
├─ 原理图: 100% 完成 (6 页)
├─ PCB: 100% 完成 (4 层, 150×100mm)
├─ Gerber: 完整的制造文件
├─ 成本: ¥350-400 保持验证
└─ 交付: 可提交 PCB 制造
```

### W4 月度总结与 M2.1 准备 (2月14日 14:00-16:00)

```
议程:

1️⃣ W2-W4 总体成果总结 (20min)
   ├─ 代码总行数: 920+ (W2 420 + W3 550 + W4 200)
   ├─ 测试覆盖率: 80%+ 达成
   ├─ 性能指标: PTP <20µs, TSN <100µs
   ├─ 硬件设计: PCB 完成 + Gerber 交付
   └─ 整体质量评估

2️⃣ 各模块状态评估 (20min)
   ├─ PTP Master: 功能完整 + 性能优化 + 80% 覆盖
   ├─ TSN Scheduler: 功能完整 + Linux 集成 + 80% 覆盖
   ├─ Zone Controller: 原理图 + PCB 完成
   └─ 风险评估: 已识别与缓解

3️⃣ M2.1 (Alpha) 准备 (15min)
   ├─ Alpha 版本范围确认
   │  ├─ PTP Master 实现 100%
   │  ├─ TSN Scheduler 实现 100%
   │  └─ 硬件参考设计 100%
   ├─ 发布流程
   │  ├─ Tag: v0.2.0-alpha.1
   │  ├─ Release Notes
   │  └─ API 文档 + 使用指南
   └─ 后续 M2.2 (Beta) 计划

4️⃣ W5-W8 计划预告 (5min)
   ├─ 硬件验证 & 第一批 PCB
   ├─ 跨平台适配 (STM32H7, RK3588, ESP32)
   ├─ 可靠性测试
   └─ 文档完善
```

---

## 跨周协调

### W2-W3 交接 (2月2日)

```
待交接项目:

1. PTP Team
   ├─ 交接: 200+ LOC 代码框架
   ├─ 测试: 运行成功, 40%+ 覆盖
   ├─ 接收: 完整的消息定义与 BMC 算法
   └─ 启动: W3 SYNC/DELAY 开发

2. TSN Team
   ├─ 交接: 220+ LOC 代码框架
   ├─ 测试: 运行成功, 40%+ 覆盖
   ├─ 接收: 完整的队列和调度框架
   └─ 启动: W3 流量分类和带宽控制

3. Hardware Team
   ├─ 交接: 原理图 50% + 电源完整
   ├─ 接收: 处理器和网络框架
   └─ 启动: W3 网络和 PTP 硬件设计
```

### W3-W4 交接 (2月9日)

```
待交接项目:

1. PTP Team
   ├─ 交接: 完整 SYNC/DELAY 实现 (250+)
   ├─ 测试: 60%+ 覆盖
   ├─ 接收: 完整的消息流程
   └─ 启动: W4 性能优化

2. TSN Team
   ├─ 交接: 完整流量和带宽控制 (250+)
   ├─ 测试: 60%+ 覆盖, Linux 集成
   ├─ 接收: 完整的 taprio 集成
   └─ 启动: W4 性能优化

3. Hardware Team
   ├─ 交接: 原理图 75% (6 页中 4.5 页)
   ├─ 接收: PTP 硬件设计完成
   └─ 启动: W4 PCB 设计与制造准备
```

### 周跨度依赖关系

```
          W2            W3            W4
PTP:   ┌─────────┬─────────────────┬──────────────┐
       │ Framework│ SYNC/DELAY      │ Optimization │
       └─────────┴─────────────────┴──────────────┘

TSN:   ┌─────────┬─────────────────┬──────────────┐
       │ Framework│ Traffic/BW      │ Optimization │
       └─────────┴─────────────────┴──────────────┘

HW:    ┌─────────┬─────────────────┬──────────────┐
       │ 50%     │ 75%             │ 100% + PCB   │
       └─────────┴─────────────────┴──────────────┘

集成:  ┌─────────────────────────────┬──────────────┐
       │ 独立开发                     │ 联合验证     │
       └─────────────────────────────┴──────────────┘
```

---

## 风险与缓解

### 识别的关键风险

| 风险 | 概率 | 影响 | 缓解措施 | 触发条件 |
|------|------|------|--------|---------|
| PTP 延迟无法达到 <20µs | 中 | 高 | 提前进行性能基准测试, 预留优化时间 | W3 末期检查 |
| TSN Linux 集成困难 | 低 | 中 | 预准备 taprio 接口测试环境 | W3 中期 |
| 硬件 PCB 设计延迟 | 低 | 高 | 预分配设计资源, 并行工作 | 2月10日检查 |
| 跨系统集成问题 | 中 | 中 | W4 预留集成测试时间 | 2月12日后 |

### 缓解行动计划

```
🟢 绿灯 (正常推进):
├─ W3 末: PTP 性能 40-50µs, 趋势向下
├─ W3 末: TSN 覆盖率 60%+, 算法稳定
├─ W3 末: 硬件原理图 75% 按计划
└─ 行动: 正常推进, 预留优化时间

🟡 黄灯 (需关注):
├─ W3 末: PTP 性能 50-100µs, 趋势不明确
├─ W3 末: TSN Linux 集成遇到困难
├─ W3 末: 硬件设计滞后 10%+
└─ 行动: 增加优化时间, 寻求专家支持

🔴 红灯 (需立即行动):
├─ W4 初: PTP 无法优化至 <50µs
├─ W4 初: TSN 算法存在根本性缺陷
├─ W4 初: 硬件设计无法在 W4 完成
└─ 行动: 立即启动应急计划, 评估 M2.1 范围

应急计划:
├─ 范围调整: M2.1 可能仅包含 PTP 或 TSN
├─ 时间延长: W5-W6 继续优化与验证
├─ 资源增加: 寻求外部支持 (外包优化, 咨询专家)
└─ 风险沟通: 及时向利益相关方汇报
```

---

## 成功标准 (Definition of Done)

### W3 周度 DoD

```
代码:
  ☐ PTP 代码: 250+ LOC (new + modified)
  ☐ TSN 代码: 250+ LOC (new + modified)
  ☐ 所有新代码编译无警告
  ☐ 无内存泄漏 (Valgrind/ASan 通过)

测试:
  ☐ PTP 单元测试: 60%+ 覆盖率
  ☐ TSN 单元测试: 60%+ 覆盖率
  ☐ 所有 PR 已审查通过
  ☐ CI/CD 全部通过

硬件:
  ☐ 原理图: 75% 完成 (5.5/6 页)
  ☐ 所有关键电路经过审查
  ☐ DFM 预检查通过

其他:
  ☐ 周度进度报告已提交
  ☐ 风险评估已更新
  ☐ 技术债清单已汇总
```

### W4 周度 DoD (也是 M2.1 前置条件)

```
代码:
  ☐ PTP 代码: 总计 600+ LOC (W2 + W3 + W4)
  ☐ TSN 代码: 总计 620+ LOC (W2 + W3 + W4)
  ☐ 编译无警告, 所有测试通过
  ☐ 无已知的内存泄漏或崩溃

测试:
  ☐ PTP 单元测试: 80%+ 覆盖率
  ☐ TSN 单元测试: 80%+ 覆盖率
  ☐ 集成测试: PTP + TSN 联合验证通过
  ☐ 性能基准达成: PTP <20µs, TSN <100µs

硬件:
  ☐ 原理图: 100% 完成 (6 页)
  ☐ PCB 设计: 100% 完成 (4 层布局)
  ☐ Gerber 文件: 生成并通过 DFM 检查
  ☐ BOM: 更新, 成本确认 ¥350-400

文档:
  ☐ API 文档: 完整 (PTP + TSN)
  ☐ 使用指南: 完整 (快速开始 + 详细说明)
  ☐ 性能报告: 完整 (基准数据 + 对标)
  ☐ 硬件文档: 完整 (原理图 + PCB + BOM)

M2.1 交付:
  ☐ 代码 Tag: v0.2.0-alpha.1
  ☐ Release Notes: 完整
  ☐ 所有交付物已清点与验证
```

---

## 附录: 快速参考

### W3 关键日期

- **2月3日**: W3 启动, PTP + TSN 并行开发
- **2月4日**: PTP SYNC, TSN 流量分类完成
- **2月5日**: PTP DELAY, TSN 带宽控制完成
- **2月6日**: TSN Linux 集成完成, 硬件网络设计
- **2月7日**: W3 周度评审, 75% 原理图完成
- **2月8-9日**: 优化与测试冲刺

### W4 关键日期

- **2月10日**: W4 启动, PCB 设计启动
- **2月11日**: 原理图完成, PCB 初步布局
- **2月12日**: PCB 布线 50% 完成
- **2月13日**: PCB 布线完成, 规则检查
- **2月14日**: Gerber 生成, M2.1 准备
- **2月15-16日**: 最后检查与汇总

### 团队日常 Standup 模板 (W3-W4)

```
【日期】YYYY-MM-DD
【参与】Alice (PTP), Bob (TSN), Charlie (HW)

【Alice 报告】(PTP)
昨日完成: [列出具体完成的模块]
今日计划: [列出今日目标]
障碍/风险: [如有阻塞]
代码行数: [累计]
覆盖率: [最新数据]

【Bob 报告】(TSN)
昨日完成: [列出具体完成的模块]
今日计划: [列出今日目标]
障碍/风险: [如有阻塞]
代码行数: [累计]
覆盖率: [最新数据]

【Charlie 报告】(HW)
昨日完成: [列出完成的原理图页数]
今日计划: [列出今日目标]
障碍/风险: [如有阻塞]
原理图进度: [%]
PCB 准备: [如适用]
```

---

**制定日期**: 2026-01-20  
**执行期**: 2026-02-03 至 2026-02-16  
**下一版本**: 2026-02-17 (W5 计划)
