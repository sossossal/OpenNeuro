name: PTP Stack CI

on:
  push:
    branches: [develop, main]
    paths:
      - "ptp-stack/**"
      - ".github/workflows/ci-ptp.yml"
  pull_request:
    branches: [develop]
    paths:
      - "ptp-stack/**"

env:
  BUILD_TYPE: Release
  CMAKE_VERSION: 3.20

jobs:
  build-and-test:
    name: Build & Test (${{ matrix.os }}, ${{ matrix.compiler }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        compiler: [gcc, clang]
        exclude:
          - os: windows-latest
            compiler: clang
          - os: macos-latest
            compiler: gcc

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            libgtest-dev \
            gcov \
            lcov

      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install cmake googletest llvm

      - name: Install dependencies (Windows)
        if: runner.os == 'Windows'
        run: |
          choco install cmake -y
          choco install llvm -y

      - name: Configure compiler (Linux)
        if: runner.os == 'Linux'
        run: |
          if [ "${{ matrix.compiler }}" = "gcc" ]; then
            echo "CC=gcc" >> $GITHUB_ENV
            echo "CXX=g++" >> $GITHUB_ENV
          else
            echo "CC=clang" >> $GITHUB_ENV
            echo "CXX=clang++" >> $GITHUB_ENV
          fi

      - name: Configure compiler (macOS)
        if: runner.os == 'macOS'
        run: |
          if [ "${{ matrix.compiler }}" = "clang" ]; then
            echo "CC=$(brew --prefix llvm)/bin/clang" >> $GITHUB_ENV
            echo "CXX=$(brew --prefix llvm)/bin/clang++" >> $GITHUB_ENV
          fi

      - name: Create build directory
        run: |
          mkdir -p ptp-stack/build

      - name: Configure CMake
        working-directory: ptp-stack/build
        run: |
          cmake .. \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -DCMAKE_CXX_FLAGS_RELEASE="-O3 -DNDEBUG" \
            -DCMAKE_C_FLAGS_RELEASE="-O3 -DNDEBUG"

      - name: Build
        working-directory: ptp-stack/build
        run: cmake --build . --config ${{ env.BUILD_TYPE }} --parallel 4

      - name: Run unit tests
        working-directory: ptp-stack/build
        run: ctest --output-on-failure --verbose

      - name: Collect coverage (Linux)
        if: runner.os == 'Linux' && matrix.compiler == 'gcc'
        working-directory: ptp-stack/build
        run: |
          cmake --build . --target coverage || true

      - name: Upload coverage to Codecov
        if: runner.os == 'Linux' && matrix.compiler == 'gcc'
        uses: codecov/codecov-action@v3
        with:
          files: ./ptp-stack/build/coverage.xml
          flags: unittests
          name: codecov-ptp-${{ matrix.os }}

      - name: Archive build artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts-${{ matrix.os }}-${{ matrix.compiler }}
          path: |
            ptp-stack/build/CMakeFiles/CMakeOutput.log
            ptp-stack/build/CMakeFiles/CMakeError.log
          retention-days: 7

  code-quality:
    name: Code Quality Check
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y cppcheck clang-format

      - name: Run cppcheck
        working-directory: ptp-stack
        run: |
          cppcheck --enable=all --suppress=missingIncludeSystem \
            --suppress=missingInclude src/ tests/ || true

      - name: Check code formatting
        working-directory: ptp-stack
        run: |
          find src tests -name "*.c" -o -name "*.h" | \
          xargs clang-format --dry-run -Werror || true

  static-analysis:
    name: Static Analysis
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: cpp

      - name: Build PTP Stack
        run: |
          cd ptp-stack
          mkdir -p build
          cd build
          cmake .. -DCMAKE_BUILD_TYPE=Release
          cmake --build . --parallel 4

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
