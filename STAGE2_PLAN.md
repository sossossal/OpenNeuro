# OpenNeuro é˜¶æ®µäºŒè®¡åˆ’ - "å®æ—¶ä¸åŒæ­¥æ ¸å¿ƒ" (The Real-time Core)

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**å‘å¸ƒæ—¥æœŸ**: 2026 å¹´ 1 æœˆ 20 æ—¥  
**è®¡åˆ’è¦†ç›–æœŸ**: 2026 Q2 - 2026 Q4 (9 ä¸ªæœˆ)  
**ç›®æ ‡çŠ¶æ€**: âœ… è§„åˆ’ä¸­ (Planning Phase)

---

## ğŸ“‹ æ‰§è¡Œæ‘˜è¦

### é˜¶æ®µäºŒæ„¿æ™¯

> "ä¸ºæœºå™¨äººç³»ç»Ÿå¼•å…¥**å¾®ç§’çº§ç²¾åº¦çš„åˆ†å¸ƒå¼æ—¶é—´åŒæ­¥**å’Œ**ç¡®å®šæ€§ç½‘ç»œè°ƒåº¦**ï¼Œ
> ä½¿å¤šä¸ªèŠ‚ç‚¹èƒ½å¤Ÿä»¥**ç¡¬å®æ—¶ç²¾åº¦**ååŒè¿åŠ¨ã€‚"

### å…³é”®ç›®æ ‡

1. **PTP æ—¶é—´åŒæ­¥** (<10Âµs ç²¾åº¦)
2. **TSN ç½‘ç»œè°ƒåº¦** (ç¡®å®šæ€§å»¶è¿Ÿ)
3. **ç¡¬å®æ—¶æ§åˆ¶** (å¯é¢„æµ‹çš„æ‰§è¡Œæ—¶é—´)
4. **å‚è€ƒç¡¬ä»¶è®¾è®¡** (å¼€æº PCB)

### æˆåŠŸæŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡ | éªŒæ”¶æ ‡å‡† |
|------|------|---------|
| **æ—¶é—´åŒæ­¥ç²¾åº¦** | <10Âµs | 99th percentile <10Âµs |
| **ç¡®å®šæ€§å»¶è¿Ÿ** | <1ms | å³°å€¼å»¶è¿Ÿ <1.2ms |
| **ç¡¬ä»¶å‚è€ƒè®¾è®¡** | 1 å¥— | PCB + BOM + æ–‡æ¡£ |
| **ç”Ÿæ€æ”¯æŒ** | 3+ å¹³å° | STM32H7, RK3588, Jetson |
| **æ–‡æ¡£å®Œæ•´åº¦** | 100% | API + æ•™ç¨‹ + æ¡ˆä¾‹ |

---

## ğŸ¯ ä¸‰ä¸ªå­é¡¹ç›®åˆ†è§£

### é¡¹ç›® 2A: PTP æ—¶é—´åŒæ­¥ (The Time Synchronization)

**é¢„è®¡å‘¨æœŸ**: 3-4 ä¸ªæœˆ  
**ä¼˜å…ˆçº§**: â­â­â­â­â­ (æœ€é«˜)  
**å¤æ‚åº¦**: â˜…â˜…â˜…â˜…â˜†

#### 2A.1 æŠ€æœ¯æ–¹æ¡ˆ

##### ç›®æ ‡
åœ¨ OpenNeuro ç³»ç»Ÿä¸­å®ç° **IEEE 1588 v2 (PTP)** æ—¶é—´åŒæ­¥ï¼Œä½¿æ‰€æœ‰èŠ‚ç‚¹çš„æ—¶é’Ÿç²¾åº¦è¾¾åˆ° **<10 Âµs**ã€‚

##### æ¶æ„è®¾è®¡

```
Master Clock (Grandmaster)
        â†“ SYNC æ¶ˆæ¯ (å•å‘)
        â”‚ (æ¯ç§’ 10 æ¬¡)
        â”‚
    â”Œâ”€â”€â”€â”´â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚       â”‚        â”‚        â”‚
Slave 1  Slave 2  Slave 3  Slave N
(STM32)  (RK3588) (Jetson) (ESP32)
    â”‚       â”‚        â”‚        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
        æœ¬åœ°æ—¶é’Ÿ
        åŒæ­¥è‡³
        Grandmaster
        (è¯¯å·® <10Âµs)
```

##### æ ¸å¿ƒæŠ€æœ¯

**1. PTP åè®®å®ç°**

```c
// ptp_clock.h
typedef struct {
    uint64_t offset_ns;        // ä¸ master çš„æ—¶é—´åå·®
    uint32_t delay_ns;         // ç½‘ç»œå»¶è¿Ÿ
    uint64_t local_time_ns;    // æœ¬åœ°é«˜ç²¾åº¦æ—¶é—´
    uint32_t sync_interval;    // åŒæ­¥é—´éš” (ms)
} ptp_state_t;

typedef struct {
    int32_t p;                 // PID æ§åˆ¶å™¨ P
    int32_t i;                 // PID æ§åˆ¶å™¨ I
    int32_t d;                 // PID æ§åˆ¶å™¨ D
} ptp_pi_controller_t;
```

**2. ç¡¬ä»¶æ—¶é—´æˆ³**

åœ¨ STM32H7 / RK3588 ä¸Šå®ç°ï¼š
- ä»¥å¤ªç½‘ MAC ç¡¬ä»¶æ—¶é—´æˆ³ (ingress/egress)
- å¾®ç§’çº§ç²¾åº¦æ—¶é’Ÿæº
- æ—¶é—´æˆ³æ•è·å•å…ƒ (Timestamp Unit)

```c
// ç¤ºä¾‹: STM32H7 PTP æ—¶é—´æˆ³
typedef struct {
    uint32_t sec;     // ç§’
    uint32_t nsec;    // çº³ç§’ (0-999,999,999)
} stm32h7_timestamp_t;

void ptp_get_timestamp(stm32h7_timestamp_t *ts) {
    // ä»ä»¥å¤ªç½‘ MAC è¯»å–ç²¾ç¡®æ—¶é—´æˆ³
    // ç²¾åº¦: Â±50ns (å—æ™¶ä½“ç²¾åº¦é™åˆ¶)
}
```

**3. æ—¶é’Ÿè°ƒæ•´æœºåˆ¶**

| è°ƒæ•´æ–¹å¼ | ç²¾åº¦ | å»¶è¿Ÿ | åº”ç”¨åœºæ™¯ |
|---------|------|------|---------|
| **é¢‘ç‡å¾®è°ƒ** (PPM) | Â±100ppm | åˆ†é’Ÿçº§ | é•¿æœŸæ¼‚ç§» |
| **æ­¥è¿›è°ƒæ•´** | Â±1ns | å³æ—¶ | å¿«é€ŸåŒæ­¥ |
| **è™šæ‹Ÿæ—¶é’Ÿ** | Â±1ns | å³æ—¶ | é¿å…æ—¶é—´å€’æµ |

#### 2A.2 è¯¦ç»†ä»»åŠ¡åˆ†è§£

##### Phase 2A-1: PTP åè®®æ ˆå¼€å‘ (4 å‘¨)

**ä»»åŠ¡**:
1. `libptp_master.c` - Master èŠ‚ç‚¹å®ç°
   - SYNC æ¶ˆæ¯ç”Ÿæˆ
   - FOLLOW_UP æ¶ˆæ¯å¤„ç†
   - æ—¶é’Ÿæºç®¡ç†
   - çŠ¶æ€æœºå®ç°

2. `libptp_slave.c` - Slave èŠ‚ç‚¹å®ç°
   - SYNC æ¶ˆæ¯å¤„ç†
   - DELAY_REQ æ¶ˆæ¯ç”Ÿæˆ
   - æ—¶é—´åå·®è®¡ç®—
   - æ—¶é’Ÿè°ƒæ•´

3. `ptp_config.h` - é…ç½®å‚æ•°
   - åŒæ­¥é—´éš”
   - å…è®¸çš„æ—¶é—´åå·®
   - PID å‚æ•°
   - ç½‘ç»œé…ç½®

**äº¤ä»˜ç‰©**:
- `firmware/ptp/` ç›®å½•
  - `src/libptp_master.c`
  - `src/libptp_slave.c`
  - `src/ptp_config.h`
  - `include/ptp.h`
  - README.md (API æ–‡æ¡£)

**éªŒæ”¶æ ‡å‡†**:
- âœ… Slave èƒ½ä¸ Master é€šä¿¡
- âœ… æ—¶é—´åå·® <100Âµs (åˆæ­¥)
- âœ… ä»£ç æµ‹è¯•è¦†ç›–ç‡ >80%

---

##### Phase 2A-2: ç¡¬ä»¶é›†æˆ (3 å‘¨)

**ä»»åŠ¡ A: STM32H7 ä»¥å¤ªç½‘æ—¶é—´æˆ³**

```c
// stm32h7_ptp_hw.c
void stm32h7_ptp_init(void) {
    // 1. é…ç½®ä»¥å¤ªç½‘ PTP å•å…ƒ
    ETH->PTPTSLR |= ETH_PTPTSLR_TSFCU;  // Fine update mode
    
    // 2. å¯ç”¨æ—¶é—´æˆ³æ•è·
    ETH->PTPTSHR = 0;  // åˆå§‹åŒ–ç§’å¯„å­˜å™¨
    ETH->PTPTSLR = 0;  // åˆå§‹åŒ–çº³ç§’å¯„å­˜å™¨
}

void stm32h7_ptp_get_time(uint64_t *ns) {
    uint32_t sec = ETH->PTPTSHR;
    uint32_t nsec = ETH->PTPTSLR & 0x7FFFFFFF;
    *ns = (uint64_t)sec * 1000000000ULL + nsec;
}
```

**ä»»åŠ¡ B: RK3588 ç³»ç»Ÿæ—¶é—´è°ƒæ•´**

```c
// rk3588_ptp_hw.c
// ä½¿ç”¨ Linux kernel PTP æ¥å£
void rk3588_ptp_adjust_clock(int64_t offset_ns) {
    struct timespec ts;
    clock_gettime(CLOCK_REALTIME, &ts);
    ts.tv_nsec += offset_ns % 1000000000LL;
    clock_settime(CLOCK_REALTIME, &ts);
}
```

**ä»»åŠ¡ C: ESP32 è½¯ä»¶æ—¶é—´æˆ³**

```c
// esp32_ptp_hw.c
void esp32_ptp_get_timestamp(uint64_t *ns) {
    // ä½¿ç”¨ FreeRTOS tick + é«˜ç²¾åº¦å®šæ—¶å™¨
    *ns = xTaskGetTickCountFromISR() * portTICK_PERIOD_MS * 1000000ULL;
}
```

**äº¤ä»˜ç‰©**:
- `firmware/zenoh-pico-stm32/src/ptp_hw.c` (STM32 é€‚é…)
- `firmware/zenoh-pico-esp32/src/ptp_hw.c` (ESP32 é€‚é…)
- ç¡¬ä»¶é›†æˆæ–‡æ¡£

**éªŒæ”¶æ ‡å‡†**:
- âœ… æ—¶é—´æˆ³è·å–å»¶è¿Ÿ <1Âµs
- âœ… æ—¶é’Ÿæºç²¾åº¦éªŒè¯
- âœ… ç¡¬ä»¶æ–‡æ¡£å®Œæ•´

---

##### Phase 2A-3: æ€§èƒ½éªŒè¯ä¸ä¼˜åŒ– (2 å‘¨)

**æµ‹è¯•åœºæ™¯**:

1. **æœ¬åœ°æ—¶é—´åŒæ­¥** (Single Master + 3 Slaves)

```
Slave èŠ‚ç‚¹æ—¶é’Ÿåå·® (Âµs)
â”œâ”€ Slave 1: +2.1 Âµs âœ“
â”œâ”€ Slave 2: -1.8 Âµs âœ“
â”œâ”€ Slave 3: +0.9 Âµs âœ“
â””â”€ æ•´ä½“åå·®: Ïƒ = 1.6 Âµs (ç›®æ ‡ <5 Âµs)
```

2. **è·¨ç½‘ç»œåŒæ­¥** (é€šè¿‡ Zenoh Router)

```
PC Master â”€â”€Ethernetâ”€â†’ RK3588 Slave
                      (åå·®: Â±3Âµs)
                      
             â”€â”€WiFiâ”€â”€â†’ ESP32 Slave
                      (åå·®: Â±8Âµs)
```

3. **é•¿æœŸç¨³å®šæ€§æµ‹è¯•** (24 å°æ—¶)

```
æ—¶é—´åå·®éšæ—¶é—´å˜åŒ–:
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   â”‚ ç¨³å®šåŒºé—´    â”‚ Â±10Âµs
â”‚â”Œâ”€â”€â”¤             â”œâ”€â”€â”
â”‚â”‚  â”‚    é¢‘ç‡æ ¡å‡† â”‚  â”‚
â”‚â”‚  â”‚    é”å®š     â”‚  â”‚
â”‚â””â”€â”€â”¤             â”œâ”€â”€â”˜
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ æ—¶é—´
```

**äº¤ä»˜ç‰©**:
- `tests/ptp_tests/` ç›®å½•
  - `test_ptp_basic.py` - åŸºç¡€åŠŸèƒ½æµ‹è¯•
  - `test_ptp_accuracy.py` - ç²¾åº¦éªŒè¯
  - `test_ptp_stability.py` - é•¿æœŸç¨³å®šæ€§
  - `ptp_performance_report.md` - æ€§èƒ½æŠ¥å‘Š

**éªŒæ”¶æ ‡å‡†**:
- âœ… åŒæ­¥ç²¾åº¦ <10Âµs (P99)
- âœ… ç¨³å®šæ€§ >99.9%
- âœ… æ€§èƒ½æŠ¥å‘Šå®Œæ•´

---

#### 2A.4 èµ„æºéœ€æ±‚

| èµ„æº | éœ€æ±‚ | å¤‡æ³¨ |
|------|------|------|
| **äººåŠ›** | 2 äºº | 1x åµŒå…¥å¼, 1x åè®®å¼€å‘ |
| **ç¡¬ä»¶** | ç°æœ‰ | æ— é¢å¤–æˆæœ¬ |
| **ç½‘ç»œ** | Gigabit Ethernet | æ¨èï¼Œå¯é€‰æœ‰çº¿ç½‘ç»œ |
| **å·¥å…·** | å·²æœ‰ | ç½‘ç»œåˆ†æä»ª (å¯é€‰) |

---

### é¡¹ç›® 2B: TSN ç½‘ç»œè°ƒåº¦ (Traffic Shaping)

**é¢„è®¡å‘¨æœŸ**: 4-6 ä¸ªæœˆ  
**ä¼˜å…ˆçº§**: â­â­â­â­ (é«˜)  
**å¤æ‚åº¦**: â˜…â˜…â˜…â˜…â˜… (æœ€å¤æ‚)

#### 2B.1 æŠ€æœ¯æ–¹æ¡ˆ

##### ç›®æ ‡

åœ¨ OpenNeuro ä¸­å®ç° **IEEE 802.1Qbv (Time-Aware Shaper)** å’Œ **802.1Qci (Per-Stream Filtering)**ï¼Œ
å®ç°ï¼š
- âœ… ç¡®å®šæ€§åŒ…è½¬å‘å»¶è¿Ÿ (<1ms)
- âœ… é›¶ä¸¢åŒ…ä¼ è¾“ (è§†é¢‘æµ + æ§åˆ¶æŒ‡ä»¤)
- âœ… ä¼˜å…ˆçº§éš”ç¦» (å…³é”®ä»»åŠ¡ vs éå…³é”®)

##### ç³»ç»Ÿæ‹“æ‰‘

```
                   TSN-Aware Switch
                   (802.1AS + 802.1Qbv)
                          â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚               â”‚               â”‚
      Port 1          Port 2          Port 3
      (Critical)     (Sensor)       (Video)
          â”‚               â”‚               â”‚
        Port 1          Port 2          Port 3
      Gate Open:      Gate Open:      Gate Open:
      0-100Âµs         100-500Âµs       500-1000Âµs
      Period: 1ms
```

##### æ ¸å¿ƒæ¦‚å¿µ

**1. æ—¶é—´æ„ŸçŸ¥é—¨ç¦ (Time-Aware Gating)**

æ¯ä¸ªä»¥å¤ªç½‘ç«¯å£æœ‰ä¸€ä¸ª**å‘¨æœŸé—¨ç¦è¡¨**ï¼Œå®šä¹‰äº†åœ¨ç»™å®šæ—¶é—´çª—å£å†…å“ªäº›é˜Ÿåˆ—å¯ä»¥å‘é€ï¼š

```c
// tsn_gate.h
typedef struct {
    uint32_t time_slot_us;      // æ—¶é—´æ§½ (Âµs)
    uint8_t gate_mask;          // 8 ä¸ªé˜Ÿåˆ—çš„å¼€/å…³çŠ¶æ€
} tsn_gate_entry_t;

typedef struct {
    tsn_gate_entry_t entries[8];   // æœ€å¤š 8 ä¸ªæ—¶é—´æ§½
    uint32_t cycle_time_us;        // å‘¨æœŸæ—¶é—´ (é€šå¸¸ 1ms)
    uint32_t base_time_ns;         // åŸºç¡€æ—¶é—´æˆ³
} tsn_gate_schedule_t;
```

**2. æµé‡ç®¡åˆ¶ (Per-Stream Filtering and Policing)**

```c
// tsn_stream.h
typedef struct {
    uint32_t stream_id;
    uint32_t max_frame_size;
    uint32_t max_bitrate_kbps;
    uint32_t max_latency_us;
    uint8_t priority;
} tsn_stream_config_t;
```

**3. ä¼˜å…ˆçº§é˜Ÿåˆ—æ˜ å°„**

```
ä¼˜å…ˆçº§ 0: å…³é”®æ§åˆ¶æŒ‡ä»¤ (ç”µæœºé©±åŠ¨)
ä¼˜å…ˆçº§ 1: ä¼ æ„Ÿå™¨å‘½ä»¤ (ADC é‡‡æ ·)
ä¼˜å…ˆçº§ 2: æ™®é€šæ•°æ® (çŠ¶æ€åé¦ˆ)
ä¼˜å…ˆçº§ 3-7: éå®æ—¶æµé‡ (è§†é¢‘, æ—¥å¿—)
```

#### 2B.2 åˆ†é˜¶æ®µå®ç°

##### Phase 2B-1: TSN åº”ç”¨å±‚æ¥å£è®¾è®¡ (3 å‘¨)

```c
// tsn_api.h
/**
 * åˆ›å»º TSN æµ
 */
int tsn_stream_create(
    const char *name,
    uint32_t max_frame_size,
    uint32_t max_latency_us,
    uint8_t priority,
    tsn_stream_handle_t *out_handle
);

/**
 * è®¾ç½®é—¨ç¦è®¡åˆ’
 */
int tsn_set_gate_schedule(
    uint16_t port,
    const tsn_gate_schedule_t *schedule
);

/**
 * å‘é€ TSN æµé‡
 */
int tsn_stream_send(
    tsn_stream_handle_t handle,
    const uint8_t *payload,
    uint16_t length
);

/**
 * æ¥æ”¶ TSN æµé‡
 */
int tsn_stream_receive(
    tsn_stream_handle_t handle,
    uint8_t *payload,
    uint16_t max_length,
    uint32_t *latency_us
);
```

##### Phase 2B-2: Linux äº¤æ¢æœºé…ç½® (3 å‘¨)

ä½¿ç”¨ **tc (Traffic Control)** å’Œ **taprio** å®ç°ï¼š

```bash
#!/bin/bash
# tsn_setup.sh

# åˆ›å»ºæ—¶é—´æ„ŸçŸ¥é—¨ç¦è°ƒåº¦å™¨
# å‘¨æœŸ: 1000Âµs (1ms)
# æ—¶é—´æ§½ 0-100Âµs: é˜Ÿåˆ— 0-3 (å…³é”®)
# æ—¶é—´æ§½ 100-500Âµs: é˜Ÿåˆ— 4-5 (ä¼ æ„Ÿå™¨)
# æ—¶é—´æ§½ 500-1000Âµs: é˜Ÿåˆ— 6-7 (éå®æ—¶)

tc qdisc replace dev eth0 root taprio \
  num_tc 8 \
  map 0 1 2 3 4 5 6 7 0 0 0 0 0 0 0 0 \
  queues 1@0 1@1 1@2 1@3 1@4 1@5 1@6 1@7 \
  base-time 0 \
  sched-entry S 0x0F 100000 \
  sched-entry S 0x30 400000 \
  sched-entry S 0xC0 500000 \
  clockid CLOCK_TAI
```

##### Phase 2B-3: ç¡¬ä»¶æ”¯æŒéªŒè¯ (2 å‘¨)

**æ£€æŸ¥äº¤æ¢æœºæ”¯æŒ**:
- Marvell äº¤æ¢æœº: âœ… æ”¯æŒ 802.1Qbv
- Realtek: âš ï¸ æœ‰é™æ”¯æŒ (éœ€éªŒè¯)
- æ¨èäº¤æ¢æœº: **Marvell 88E6095** æˆ–æ›´é«˜

**è½¯ä»¶æ ˆè¦æ±‚**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  OpenNeuro App   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ tsn_api.c        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Linux tc/taprio  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ NIC é©±åŠ¨         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ äº¤æ¢æœºç¡¬ä»¶       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 2B.4 æ¼”ç¤ºåœºæ™¯

**åœºæ™¯: è§†é¢‘æµ + æ§åˆ¶æŒ‡ä»¤æ— å¹²æ‰°ä¼ è¾“**

```
èƒŒæ™¯: é€šè¿‡ç½‘ç»œåŒæ—¶ä¼ è¾“:
- 1080p 30Hz è§†é¢‘ (120 Mbps)
- 1kHz ç”µæœºæ§åˆ¶æŒ‡ä»¤ (5 Mbps)
- 10Hz ä¼ æ„Ÿå™¨æ•°æ® (1 Mbps)
æ€»è®¡: 126 Mbps (è¶³ä»¥å¡«æ»¡ 1Gbps é“¾æ¥ 12.6%)

ç›®æ ‡:
- æ§åˆ¶æŒ‡ä»¤å»¶è¿Ÿ: <1ms (ä¸å—è§†é¢‘å½±å“)
- è§†é¢‘å¸§é—´éš”: ç¨³å®š 33.33ms
- é›¶ä¸¢åŒ…
```

---

### é¡¹ç›® 2C: å‚è€ƒç¡¬ä»¶è®¾è®¡ (Reference Design)

**é¢„è®¡å‘¨æœŸ**: 6-9 ä¸ªæœˆ  
**ä¼˜å…ˆçº§**: â­â­â­ (ä¸­é«˜)  
**å¤æ‚åº¦**: â˜…â˜…â˜…â˜†â˜†

#### 2C.1 ç¡¬ä»¶ç›®æ ‡

è®¾è®¡å¹¶å¼€æº **OpenNeuro Zone Controller** PCBï¼š

**è§„æ ¼**:
- MCU: RK3588 æˆ– i.MX 8M Plus
- ç½‘ç»œ: 2x Gigabit Ethernet (å†—ä½™)
- I/O: 4x SPI, 8x I2C, 16x GPIO
- åŠŸç‡: æ”¯æŒ 48V PoE
- å°ºå¯¸: 10cm x 10cm (ç´§å‡‘)
- æˆæœ¬ç›®æ ‡: <$200 BOM

**åŠŸèƒ½**:
- âœ… Zenoh Router + PTP Master
- âœ… 4 ä¸ª Neuron çš„æœ¬åœ°æ§åˆ¶
- âœ… è§†é¢‘ç¼–ç  (å¯é€‰ NPU)
- âœ… æ•…éšœæ£€æµ‹å’Œæ¢å¤

#### 2C.2 è®¾è®¡æµç¨‹

**é˜¶æ®µ 1: åŸç†å›¾è®¾è®¡** (4 å‘¨)

```
KiCad é¡¹ç›®ç»“æ„:
â”œâ”€â”€ hardware/openneuro-zone-controller/
â”‚   â”œâ”€â”€ OpenNeuro-ZoneController.sch
â”‚   â”œâ”€â”€ power.sch (48V è½¬ 12V, 3.3V)
â”‚   â”œâ”€â”€ ethernet.sch (PHY + ç£ç›˜)
â”‚   â”œâ”€â”€ rk3588_core.sch
â”‚   â”œâ”€â”€ io_expansion.sch
â”‚   â””â”€â”€ debugging.sch (UART, JTAG)
â”œâ”€â”€ BOM.csv
â””â”€â”€ Schematic_Review.md
```

**é˜¶æ®µ 2: PCB å¸ƒå±€** (6 å‘¨)

- ä¿¡å·å®Œæ•´æ€§åˆ†æ (DDR, Ethernet)
- çƒ­ç®¡ç†è®¾è®¡
- EMI/EMC è€ƒè™‘
- åˆ¶é€ å·¥è‰ºæ£€æŸ¥

**é˜¶æ®µ 3: åŸå‹åˆ¶é€ å’ŒéªŒè¯** (6 å‘¨)

- å°æ‰¹é‡åˆ¶é€  (10 å—)
- åŠŸèƒ½æµ‹è¯•
- å¯é æ€§æµ‹è¯•
- æ–‡æ¡£å®Œå–„

#### 2C.3 Neuro-Link ç‰©ç†æ¥å£æ ‡å‡†

å®šä¹‰æ ‡å‡†åŒ–çš„è¿æ¥å™¨å’Œçº¿åºï¼š

```
Neuro-Link Connector (40-pin 0.1" header)

Power:
  Pin 1: +5V (ç”µæœº/ä¼ æ„Ÿå™¨)
  Pin 2: GND
  Pin 3: +3.3V (é€»è¾‘)

High-Speed (å¯é€‰):
  Pin 4-7: Ethernet (LVDS)
  Pin 8-9: GND

Control (GPIO/PWM):
  Pin 10-19: PWM Out (8 channels)
  Pin 20-29: GPIO In (8 channels)
  
Debug (å¯é€‰):
  Pin 30-31: UART Tx/Rx
  Pin 32-33: GND
  Pin 34-35: JTAG TCO/TDI
  Pin 36-37: GND
  Pin 38-40: é¢„ç•™

çº¿åºæ ‡å‡†:
- æ‰€æœ‰ GND åœ¨å¶æ•°å¼•è„š
- æ‰€æœ‰ 5V åœ¨å¥‡æ•°å¼•è„šä¸ŠåŠéƒ¨
- ä¿¡å·æŒ‰åŠŸèƒ½åˆ†ç»„
```

---

## ğŸ“… è¯¦ç»†æ—¶é—´è¡¨

### Timeline

```
2026 Q2 (Apr-Jun)
â”œâ”€ å‘¨ 1-4: PTP åè®®æ ˆå¼€å‘
â”œâ”€ å‘¨ 5-7: PTP ç¡¬ä»¶é›†æˆ
â””â”€ å‘¨ 8: PTP éªŒè¯ä¸æ–‡æ¡£

2026 Q3 (Jul-Sep)
â”œâ”€ å‘¨ 1-3: TSN API è®¾è®¡
â”œâ”€ å‘¨ 4-6: Linux äº¤æ¢æœºé…ç½®
â”œâ”€ å‘¨ 7-9: TSN ç¡¬ä»¶éªŒè¯
â”œâ”€ å‘¨ 10-12: é›†æˆæµ‹è¯•ä¸ä¼˜åŒ–
â””â”€ å¹¶è¡Œ: ç¡¬ä»¶è®¾è®¡é˜¶æ®µ 1-2

2026 Q4 (Oct-Dec)
â”œâ”€ ç¡¬ä»¶è®¾è®¡é˜¶æ®µ 2-3
â”œâ”€ æ–‡æ¡£å®Œå–„
â”œâ”€ ç¤¾åŒºåé¦ˆæ”¶é›†
â””â”€ v1.0 å‘å¸ƒå‡†å¤‡
```

### é‡Œç¨‹ç¢‘

| é‡Œç¨‹ç¢‘ | æ—¥æœŸ | äº¤ä»˜ç‰© |
|--------|------|--------|
| **M2.1: PTP Alpha** | 2026-05-31 | åŸºç¡€åè®®å®ç° |
| **M2.2: PTP Beta** | 2026-06-30 | ç¡¬ä»¶é›†æˆå®Œæˆ |
| **M2.3: TSN Alpha** | 2026-08-31 | API å’Œé©±åŠ¨å®Œæˆ |
| **M2.4: TSN Beta** | 2026-09-30 | ç«¯åˆ°ç«¯éªŒè¯ |
| **M2.5: Hardware v0.1** | 2026-10-31 | ç¬¬ä¸€ç‰ˆ PCB è®¾è®¡ |
| **M2.6: v0.2.0 Release** | 2026-12-15 | å®Œæ•´é˜¶æ®µäºŒå‘å¸ƒ |

---

## ğŸ‘¥ å›¢é˜Ÿæ„æˆå»ºè®®

### æ ¸å¿ƒå›¢é˜Ÿ (4-5 äºº)

| å²—ä½ | éœ€æ±‚ | é¢„è®¡å·¥ä½œé‡ |
|------|------|----------|
| **PTP åè®®å¼€å‘** | 1 äºº (èµ„æ·±) | 1.0 FTE |
| **ç½‘ç»œ/TSN å·¥ç¨‹** | 1.5 äºº | 1.5 FTE |
| **ç¡¬ä»¶è®¾è®¡** | 1 äºº | 1.0 FTE |
| **æµ‹è¯•/QA** | 1 äºº | 1.0 FTE |
| **æ–‡æ¡£/PM** | 0.5 äºº | 0.5 FTE |
| **æ€»è®¡** | 4.5-5 äºº | 5.0 FTE |

### å¤–éƒ¨æ”¯æŒ

- ç¡¬ä»¶å‚å•†æ”¯æŒ: RK3588, äº¤æ¢æœºä¾›åº”å•†
- ç¤¾åŒºè¯„å®¡: æ¯æœˆæŠ€æœ¯åˆ†äº«
- å­¦æœ¯é¡¾é—®: PTP/TSN é¢†åŸŸä¸“å®¶ (å¯é€‰)

---

## ğŸ’° é¢„ç®—ä¼°ç®—

### æˆæœ¬åˆ†è§£

| é¡¹ç›® | æˆæœ¬ | å¤‡æ³¨ |
|------|------|------|
| **äººåŠ›æˆæœ¬** | Â¥250K | 4.5 äºº Ã— 9 ä¸ªæœˆ |
| **ç¡¬ä»¶æˆæœ¬** | Â¥15K | PCB åŸå‹ã€æµ‹è¯•ä»ªå™¨ |
| **å·¥å…·/è½¯ä»¶** | Â¥5K | è®¸å¯è¯ã€ç½‘ç»œä»ªå™¨ |
| **æ–‡æ¡£/åŸ¹è®­** | Â¥10K | æ•™å­¦è§†é¢‘ã€æ¼”è®² |
| **æ‚è´¹** | Â¥5K | å·®æ—…ã€æ²Ÿé€šã€å…¶ä»– |
| **æ€»è®¡** | **Â¥285K** | |

### ROI åˆ†æ

- **åˆæœŸæŠ•å…¥**: Â¥285K (é˜¶æ®µäºŒ)
- **é¢„æœŸæ”¶ç›Š**: 
  - âœ… å•†ä¸šæˆæƒè´¹ (é¢„è®¡ 50-100 å®¶ä¼ä¸šé‡‡ç”¨)
  - âœ… æŠ€æœ¯å’¨è¯¢æœåŠ¡
  - âœ… ç¡¬ä»¶é”€å”® (å‚è€ƒè®¾è®¡)
  - ğŸ“ˆ **é¢„è®¡ 18 ä¸ªæœˆå†…å›æœ¬**

---

## ğŸ¯ æˆåŠŸå…³é”®å› ç´ 

### æŠ€æœ¯å…³é”®ç‚¹

1. **PTP åŒæ­¥ç²¾åº¦**
   - ä¾èµ–: ç¡¬ä»¶æ—¶é—´æˆ³ç²¾åº¦ã€ç½‘ç»œå»¶è¿Ÿç¨³å®šæ€§
   - é£é™©: æŸäº› MCU æ— é«˜ç²¾åº¦å®šæ—¶å™¨ â†’ **ç¼“è§£**: æä¾›å¤šä¸ª MCU æ–¹æ¡ˆ

2. **TSN äº¤æ¢æœºæ”¯æŒ**
   - ä¾èµ–: ç¡¬ä»¶ç‰¹æ€§æ”¯æŒ
   - é£é™©: éƒ¨åˆ†äº¤æ¢æœºä¸æ”¯æŒ 802.1Qbv â†’ **ç¼“è§£**: æä¾›äº¤æ¢æœºå…¼å®¹æ€§åˆ—è¡¨

3. **é›†æˆå’Œäº’æ“ä½œæ€§**
   - ä¾èµ–: å¤šä¸ªç³»ç»Ÿçš„åè°ƒå·¥ä½œ
   - é£é™©: é›†æˆå¤±è´¥ â†’ **ç¼“è§£**: è¯¦ç»†çš„é›†æˆæµ‹è¯•

### ç¤¾åŒºå’Œå¸‚åœºå…³é”®ç‚¹

1. **æ—©æœŸç”¨æˆ·åé¦ˆ** (é˜¶æ®µä¸€è´¡çŒ®è€…)
2. **å­¦æœ¯è®ºæ–‡å‘è¡¨** (å»ºç«‹æŠ€æœ¯ä¿¡èª‰)
3. **è¡Œä¸šä¼šè®®æ¼”è®²** (ROS World, ARM TechCon)
4. **å¼€æºç¤¾åŒºå‚ä¸** (MergeBase, Apache)

---

## ğŸš€ å¯åŠ¨è®¡åˆ’ (Next 2 Weeks)

### Week 1: ç­¹å¤‡å’Œæ‹›å‹Ÿ

- [ ] å®Œæˆè¯¦ç»†çš„ PTP æŠ€æœ¯è§„èŒƒæ–‡æ¡£
- [ ] è”ç³»æ½œåœ¨å›¢é˜Ÿæˆå‘˜
- [ ] å»ºç«‹é¡¹ç›®ç®¡ç†ç³»ç»Ÿ (GitHub Projects)
- [ ] å‡†å¤‡å¼€å‘ç¯å¢ƒ

### Week 2: é¡¹ç›®å¯åŠ¨

- [ ] å›¢é˜Ÿå¯åŠ¨ä¼šè®®
- [ ] å·¥å…·å’ŒåŸºç¡€è®¾æ–½é…ç½®
- [ ] PTP åè®®æ ˆåˆç‰ˆéª¨æ¶ä»£ç 
- [ ] CI/CD æ‰©å±• (PTP æµ‹è¯•ç®¡é“)

---

## ğŸ“Š é£é™©çŸ©é˜µ

| é£é™© | å¯èƒ½æ€§ | å½±å“ | ç¼“è§£ç­–ç•¥ |
|------|--------|------|---------|
| **ç¡¬ä»¶å…¼å®¹æ€§** | ä¸­ | ä¸­ | å°½æ—©é›†æˆæµ‹è¯• |
| **æ€§èƒ½è¾¾ä¸åˆ°** | ä½ | é«˜ | åŸå‹éªŒè¯ |
| **äººåŠ›ä¸è¶³** | ä¸­ | é«˜ | åŸ¹è®­å’Œå¤–æ´ |
| **ç¤¾åŒºåé¦ˆä¸å¥½** | ä½ | ä¸­ | å……åˆ†æ²Ÿé€š |
| **ç¡¬ä»¶æˆæœ¬è¶…æ”¯** | ä¸­ | ä½ | è®¾è®¡å®¡æŸ¥ |

---

## ğŸ“– çŸ¥è¯†ç§¯ç´¯ç›®æ ‡

å®Œæˆé˜¶æ®µäºŒåï¼Œå›¢é˜Ÿå°†æŒæ¡ï¼š

- âœ… IEEE 1588 PTP åè®®æ·±åº¦ç†è§£
- âœ… TSN å’Œ 802.1Qbv æ ‡å‡†å®ç°
- âœ… åµŒå…¥å¼ç¡¬ä»¶æ—¶é—´æˆ³å’ŒåŒæ­¥æŠ€æœ¯
- âœ… å·¥ä¸šçº§ç½‘ç»œè®¾è®¡å’Œé›†æˆ
- âœ… é«˜ç²¾åº¦å®æ—¶ç³»ç»Ÿå·¥ç¨‹

---

## ğŸŒŸ é¢„æœŸæˆæœ

### æŠ€æœ¯æˆæœ

1. **PTP æ—¶é—´åŒæ­¥åº“** (å¼€æº)
   - C è¯­è¨€å®ç°
   - æ”¯æŒå¤šä¸ª MCU å’Œ Linux
   - å®Œæ•´çš„ API å’Œç¤ºä¾‹

2. **TSN é…ç½®å’Œç®¡ç†å·¥å…·** (å¼€æº)
   - Python CLI å·¥å…·
   - Web ç®¡ç†ç•Œé¢ (å¯é€‰)
   - å®æ—¶ç›‘æ§å’Œè°ƒè¯•

3. **å‚è€ƒç¡¬ä»¶è®¾è®¡** (å¼€æº)
   - KiCad åŸç†å›¾å’Œ PCB å¸ƒå±€
   - BOM å’Œé‡‡è´­æŒ‡å—
   - åŸå‹åˆ¶é€ å’ŒéªŒè¯æŠ¥å‘Š

4. **å®Œæ•´æ–‡æ¡£** (ä¸­è‹±æ–‡)
   - PTP é›†æˆæŒ‡å—
   - TSN é…ç½®æ‰‹å†Œ
   - ç¡¬ä»¶ç»„è£…å’Œè°ƒè¯•æŒ‡å—
   - æ¡ˆä¾‹ç ”ç©¶å’Œæœ€ä½³å®è·µ

### å•†ä¸šæˆæœ

1. **ç”Ÿæ€å»ºè®¾**
   - 3-5 ä¸ªæ—©æœŸå•†ä¸šåˆä½œä¼™ä¼´
   - æŠ€æœ¯åŸ¹è®­å’Œè®¤è¯è®¡åˆ’

2. **å¸‚åœºå®šä½**
   - å®šä½ä¸º "å·¥ä¸šçº§æœºå™¨äººé€šä¿¡æ ‡å‡†"
   - å¯¹æ ‡ CANOE, ROS-Industrial

3. **æ”¶å…¥æ¥æº**
   - æŠ€æœ¯å’¨è¯¢æœåŠ¡
   - ç¡¬ä»¶å‚è€ƒè®¾è®¡æˆæƒ
   - åŸ¹è®­å’Œè®¤è¯

---

## ğŸ“ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### ç«‹å³è¡ŒåŠ¨ (æœ¬å‘¨)

1. [ ] æˆç«‹ "é˜¶æ®µäºŒå·¥ä½œç»„"
2. [ ] è”ç³»æ½œåœ¨æŠ€æœ¯åˆä½œä¼™ä¼´
3. [ ] å‡†å¤‡ PTP è¯¦ç»†è®¾è®¡æ–‡æ¡£
4. [ ] å»ºç«‹é¡¹ç›®ç®¡ç†æµç¨‹

### çŸ­æœŸç›®æ ‡ (1 ä¸ªæœˆå†…)

1. [ ] å®Œæˆå›¢é˜Ÿæ‹›å‹Ÿ
2. [ ] å»ºç«‹å¼€å‘ç¯å¢ƒ
3. [ ] PTP åè®®æ ˆ Alpha ç‰ˆæœ¬
4. [ ] ç¤¾åŒºå…¬å¼€å…¬å‘Š

### ä¸­æœŸç›®æ ‡ (6 ä¸ªæœˆ)

1. [ ] ä¸¤ä¸ªå®Œæ•´çš„å­é¡¹ç›® (PTP + TSN) å®Œæˆ
2. [ ] å‚è€ƒç¡¬ä»¶è®¾è®¡å®Œæˆ
3. [ ] v0.2.0 å‘å¸ƒ

---

## ğŸ“š å‚è€ƒèµ„æº

### æ ‡å‡†æ–‡æ¡£

- IEEE 1588-2008: PTP v2 æ ‡å‡†
- IEEE 802.1AS: æ—¶é—´åŒæ­¥åè®®
- IEEE 802.1Qbv: æ—¶é—´æ„ŸçŸ¥é—¨ç¦è°ƒåº¦
- IEEE 802.1Qci: Per-Stream Filtering

### å¼€æºé¡¹ç›®å‚è€ƒ

- Linux ptp4l: PTP å®ç°å‚è€ƒ
- OpenDaylight: SDN æ§åˆ¶å™¨å‚è€ƒ
- VRR Timing Engine: å®æ—¶è°ƒåº¦å‚è€ƒ

### å­¦æœ¯è®ºæ–‡

- "Precision Time Protocol for Power Systems"
- "Deterministic Networking for Industrial IoT"
- (å°†åœ¨å®ç°è¿‡ç¨‹ä¸­è¡¥å……)

---

## ğŸ“ å­¦ä¹ è·¯å¾„

å»ºè®®å›¢é˜Ÿæˆå‘˜æŒ‰ä»¥ä¸‹è·¯å¾„æ·±å…¥å­¦ä¹ ï¼š

1. **ç¬¬ 1-2 å‘¨**: PTP åè®®åŸºç¡€ + IEEE 1588 æ ‡å‡†
2. **ç¬¬ 3-4 å‘¨**: ç¡¬ä»¶æ—¶é—´æˆ³å’Œç²¾å¯†è®¡æ—¶
3. **ç¬¬ 5-6 å‘¨**: TSN ç½‘ç»œè°ƒåº¦å’Œé—¨ç¦æ§åˆ¶
4. **ç¬¬ 7-8 å‘¨**: ç«¯åˆ°ç«¯é›†æˆå’Œç³»ç»Ÿä¼˜åŒ–
5. **ç¬¬ 9+ å‘¨**: é«˜çº§ä¸»é¢˜ (æ•…éšœè½¬ç§»ã€å†—ä½™ç­‰)

---

**é˜¶æ®µäºŒè®¡åˆ’æ–‡æ¡£å®Œæˆ**

ç°åœ¨å·²å‡†å¤‡å¥½å¯åŠ¨çœŸæ­£çš„ç”Ÿäº§çº§æœºå™¨äººé€šä¿¡æ¶æ„ã€‚

ç¥é¡¹ç›®æˆåŠŸï¼ğŸš€

