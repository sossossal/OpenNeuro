# TSN ç½‘ç»œè°ƒåº¦ - è¯¦ç»†æŠ€æœ¯è®¾è®¡æ–‡æ¡£

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æ—¥æœŸ**: 2026 å¹´ 1 æœˆ 20 æ—¥  
**çŠ¶æ€**: è®¾è®¡é˜¶æ®µ  
**æ‰€æœ‰è€…**: OpenNeuro TSN å·¥ä½œç»„  

---

## ğŸ“Œ æ¦‚è¿°

æœ¬æ–‡æ¡£å®šä¹‰äº†åœ¨ OpenNeuro ç³»ç»Ÿä¸­å®ç° IEEE 802.1 æ—¶é—´æ„ŸçŸ¥ç½‘ç»œ (TSN: Time-Sensitive Networking) çš„æŠ€æœ¯æ–¹æ¡ˆï¼Œ
ç›®æ ‡æ˜¯å®ç° **ç¡®å®šæ€§ç½‘ç»œå»¶è¿Ÿ (<1ms)** å’Œ **é›¶ä¸¢åŒ…ä¼ è¾“**ï¼Œ
ä¸ºå…³é”®çš„å®æ—¶æ§åˆ¶åº”ç”¨æä¾›ä¿è¯ã€‚

### æ ¸å¿ƒç›®æ ‡

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | é‡è¦æ€§ | å¤‡æ³¨ |
|------|--------|--------|------|
| **æœ€å¤§å»¶è¿Ÿ** | <1 ms (P99) | â­â­â­â­â­ | ç¡¬å®æ—¶é€šä¿¡ |
| **ä¸¢åŒ…ç‡** | 0 (< 0.01%) | â­â­â­â­â­ | å¯é æ€§ |
| **æŠ–åŠ¨** | <100 Âµs (P95-P50) | â­â­â­â­ | ç¡®å®šæ€§ |
| **æ”¯æŒçš„æµ** | >100 | â­â­â­ | å¯æ‰©å±•æ€§ |
| **äº¤æ¢æœºæ”¯æŒ** | 3+ å‹å· | â­â­â­ | å®ç”¨æ€§ |

---

## ğŸ—ï¸ TSN æŠ€æœ¯æ ˆ

### IEEE 802.1 æ ‡å‡†ç³»åˆ—

```
802.1AS     â”
(PTP)       â”‚â”€ æ—¶é—´åŒæ­¥ (æ—¶é—´å±‚)
            â”˜

802.1Qbv    â”
(æ—¶é—´é—¨ç¦)   â”‚
802.1Qci    â”œâ”€ æµé‡ç®¡åˆ¶ (æµå±‚)
(æµè¿‡æ»¤)     â”‚
802.1Qcc    â”˜
(é…ç½®æ¨¡å‹)

802.1Qat    â”
(FQTSS)     â”‚
802.1Qav    â”œâ”€ å¸¦å®½é¢„ç•™ (è·¯ç”±å±‚)
(AVB)       â”‚
802.1CB     â”˜
(å†—ä½™)
```

### OpenNeuro TSN æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åº”ç”¨å±‚ (Application Layer)                          â”‚
â”‚ â”œâ”€ ç”µæœºæ§åˆ¶ (Critical, ä¼˜å…ˆçº§ 0)                   â”‚
â”‚ â”œâ”€ ä¼ æ„Ÿå™¨é‡‡æ · (Isochronous, ä¼˜å…ˆçº§ 1-2)          â”‚
â”‚ â””â”€ è§†é¢‘/æ—¥å¿— (Best-Effort, ä¼˜å…ˆçº§ 6-7)           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ TSN åº”ç”¨æ¥å£å±‚ (TSN API)                            â”‚
â”‚ â”œâ”€ tsn_stream_create()                             â”‚
â”‚ â”œâ”€ tsn_stream_send/receive()                       â”‚
â”‚ â”œâ”€ tsn_set_schedule()                              â”‚
â”‚ â””â”€ tsn_get_stats()                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ TSN åè®®å±‚ (Linux äº¤æ¢æœº)                           â”‚
â”‚ â”œâ”€ VLAN (802.1Q)                                   â”‚
â”‚ â”œâ”€ ä¼˜å…ˆçº§é˜Ÿåˆ— (802.1p)                             â”‚
â”‚ â”œâ”€ æ—¶é—´é—¨ç¦ (taprio qdisc)                         â”‚
â”‚ â””â”€ æµè¿‡æ»¤ (tc flower)                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç¡¬ä»¶é©±åŠ¨å±‚ (Network Driver)                         â”‚
â”‚ â”œâ”€ Ethernet MAC                                     â”‚
â”‚ â”œâ”€ QoS é˜Ÿåˆ—ç®¡ç†                                     â”‚
â”‚ â””â”€ ç¡¬ä»¶æ—¶é—´æˆ³                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç‰©ç†å±‚ (Gigabit Ethernet)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ æ ¸å¿ƒæ¦‚å¿µï¼šæ—¶é—´é—¨ç¦è°ƒåº¦ (Time-Aware Shaping)

### åŸºæœ¬åŸç†

**ç›®æ ‡**: ç¡®ä¿å…³é”®æµé‡åœ¨ç²¾ç¡®çš„æ—¶é—´çª—å£å†…å‘é€ï¼Œé¿å…ä¸å…¶ä»–æµé‡å†²çªã€‚

```
å‘¨æœŸ = 1 æ¯«ç§’ (1000 å¾®ç§’)

0Âµs       100Âµs      500Âµs      1000Âµs (å‘¨æœŸå®Œ)
â”‚         â”‚          â”‚          â”‚
â”œâ”€ é—¨ 0 â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ (å…³é”®æ§åˆ¶)
â”‚ æ‰“å¼€    å…³é—­       â”‚
â”‚         â”‚
â”‚         â”œâ”€ é—¨ 1 â”€â”€â”€â”€â”€â”€â”¤ (å®æ—¶ä¼ æ„Ÿå™¨)
â”‚         â”‚ æ‰“å¼€    å…³é—­ â”‚
â”‚         â”‚              â”‚
â”‚         â”‚              â”œâ”€ é—¨ 2+ (æœ€ä½³åŠªåŠ›)
â”‚         â”‚              â”‚ æ‰“å¼€
â”‚         â”‚              â””â”€â”€â”€â”€â”€â”€â†’ (ç›´åˆ°å‘¨æœŸç»“æŸ)
â”‚         â”‚
â†“         â†“              â†“
[å…³é”®]   [å®æ—¶]         [æ™®é€š]
```

### é˜Ÿåˆ—å’Œä¼˜å…ˆçº§æ˜ å°„

```
ä¼˜å…ˆçº§ (802.1p)    ç”¨é€”              é—¨ç¦çª—å£    æœ€å¤§å»¶è¿Ÿ
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
0                  ç½‘ç»œæ§åˆ¶          0-50Âµs      <50Âµs
1                  å¤šåª’ä½“æµ          50-100Âµs    <100Âµs
2                  å¤šåª’ä½“æµ          50-100Âµs    <100Âµs
3                  æµé‡ç®¡ç†          50-100Âµs    <100Âµs
4                  å®æ—¶æ•°æ®          100-500Âµs   <500Âµs
5                  å…³é”®åº”ç”¨          500-800Âµs   <800Âµs
6                  åå°æµé‡          800-1000Âµs  <1000Âµs
7                  èƒŒæ™¯              800-1000Âµs  <1000Âµs
```

---

## ğŸ“ è°ƒåº¦ç®—æ³•è®¾è®¡

### ç®—æ³• 1: å›ºå®šå‘¨æœŸé—¨ç¦ (Cycle-based Gating)

**é€‚ç”¨åœºæ™¯**: å·¥ä¸šè‡ªåŠ¨åŒ–ï¼Œå‘¨æœŸä¸º 1-10ms çš„åº”ç”¨

```
å‘¨æœŸ T = 1 ms

é—¨ç¦è¡¨:
æ—¶é—´æ§½ 0 (0-100Âµs):   S 0x000F  (é˜Ÿåˆ— 0-3 æ‰“å¼€)
æ—¶é—´æ§½ 1 (100-500Âµs): S 0x00F0  (é˜Ÿåˆ— 4-7 æ‰“å¼€)
æ—¶é—´æ§½ 2 (500-1000Âµs):S 0xFF00  (é˜Ÿåˆ— 8+ æ‰“å¼€ï¼Œä½†è¿™é‡Œåªæœ‰ 8)

é‡Šæ”¾æ—¶é—´ = 1000 Âµs (1 ms)
åŸºç¡€æ—¶é—´ = 2026-01-20 00:00:00.000000000
```

### ç®—æ³• 2: çµæ´»è°ƒåº¦ (Flexible Scheduling)

**é€‚ç”¨åœºæ™¯**: åŠ¨æ€å·¥ä½œè´Ÿè½½

```
æµä¼˜å…ˆçº§è°ƒåº¦:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ”¶åˆ°æ•°æ®åŒ…  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æŸ¥æ‰¾æµé…ç½®  â”‚ â†’ æ‰¾åˆ° stream_id, priority
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ£€æŸ¥å½“å‰é—¨  â”‚ â†’ å½“å‰æ—¶é—´çª—å£æ˜¯å¦å…è®¸æ­¤ä¼˜å…ˆçº§?
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ˜¯ â†’ ç«‹å³è½¬å‘ â”‚
â”‚ å¦ â†’ æ’é˜Ÿ     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ’¾ æ•°æ®ç»“æ„è®¾è®¡

### TSN æµé…ç½®

```c
// tsn_stream.h

typedef struct {
    uint32_t stream_id;              // å”¯ä¸€æµæ ‡è¯†ç¬¦
    uint8_t priority;                // 0-7 (802.1p)
    uint16_t max_frame_size;         // æœ€å¤§å¸§å¤§å° (å­—èŠ‚)
    uint32_t max_latency_us;         // ç«¯åˆ°ç«¯æœ€å¤§å»¶è¿Ÿ (Âµs)
    uint32_t bandwidth_kbps;         // æ‰€éœ€å¸¦å®½ (kbps)
    uint8_t vlan_id;                 // VLAN ID (å¯é€‰)
    uint8_t color;                   // PCP (æµé‡ç€è‰²)
} tsn_stream_config_t;

typedef struct {
    tsn_stream_config_t config;
    
    // ç»Ÿè®¡ä¿¡æ¯
    uint64_t packets_sent;
    uint64_t packets_dropped;
    uint64_t bytes_transmitted;
    uint32_t max_latency_observed;
    uint32_t min_latency_observed;
    uint32_t avg_latency_observed;
} tsn_stream_t;
```

### æ—¶é—´é—¨ç¦è¡¨

```c
// tsn_gate.h

/**
 * å•ä¸ªé—¨ç¦æ¡ç›®
 * å®šä¹‰äº†åœ¨æŸä¸ªæ—¶é—´æ®µå†…å“ªäº›é˜Ÿåˆ—å¯ä»¥å‘é€
 */
typedef struct {
    uint32_t time_slot_us;           // æ—¶é—´æ§½å¼€å§‹ (ç›¸å¯¹äºå‘¨æœŸ)
    uint32_t duration_us;            // æ—¶é—´æ§½æŒç»­æ—¶é—´
    uint8_t gate_mask;               // 8 ä¸ªé˜Ÿåˆ—çš„å¼€/å…³çŠ¶æ€
                                     // bit i = 1: é˜Ÿåˆ— i æ‰“å¼€
                                     // bit i = 0: é˜Ÿåˆ— i å…³é—­
} tsn_gate_entry_t;

/**
 * å®Œæ•´çš„é—¨ç¦è®¡åˆ’
 */
typedef struct {
    uint16_t port_id;                // ä»¥å¤ªç½‘ç«¯å£å·
    tsn_gate_entry_t entries[8];     // æœ€å¤š 8 ä¸ªæ—¶é—´æ§½
    uint32_t num_entries;            // å®é™…ä½¿ç”¨çš„æ§½æ•°
    uint32_t cycle_time_us;          // å®Œæ•´å‘¨æœŸ (é€šå¸¸ 1000 Âµs = 1 ms)
    uint64_t base_time_ns;           // åŸºç¡€å‚è€ƒæ—¶é—´ (PTP æ—¶é—´æˆ³)
    uint32_t extension_time_us;      // é—­åŒ…æ—¶é—´
} tsn_gate_schedule_t;
```

### æµè¿‡æ»¤å’Œæ•´å½¢

```c
// tsn_shaper.h

/**
 * ä»¤æ¡¶ç®—æ³• (Token Bucket) å‚æ•°
 * ç”¨äºé™åˆ¶å„æµçš„å‘é€é€Ÿç‡
 */
typedef struct {
    uint32_t cir;                    // æ‰¿è¯ºä¿¡æ¯é€Ÿç‡ (bps)
    uint32_t cbs;                    // æ‰¿è¯ºçªå‘å¤§å° (å­—èŠ‚)
    uint32_t ebs;                    // è¶…é¢çªå‘å¤§å° (å­—èŠ‚)
    
    // è¿è¡Œæ—¶çŠ¶æ€
    uint32_t tokens;                 // å½“å‰ä»¤æ¡¶ä¸­çš„ä»¤ç‰Œæ•°
    uint64_t last_refresh;           // æœ€åè¡¥å……ä»¤æ¡¶çš„æ—¶é—´
} tsn_token_bucket_t;

/**
 * å•ä¸ªæµçš„æ•´å½¢å™¨
 */
typedef struct {
    uint32_t flow_id;
    tsn_token_bucket_t bucket;
    
    // é¢œè‰²æ ‡è®° (Green/Yellow/Red)
    uint8_t color;                   // 0=Green, 1=Yellow, 2=Red
} tsn_shaper_t;
```

---

## ğŸ”§ Linux äº¤æ¢æœºå®ç°

### ä½¿ç”¨ tc (Traffic Control) å‘½ä»¤

#### Step 1: åˆ›å»º VLAN æ¥å£ (å¯é€‰)

```bash
#!/bin/bash
# ä¸ºä¸åŒä¼˜å…ˆçº§åˆ›å»ºè™šæ‹Ÿæ¥å£

# VLAN 1: å…³é”®æµé‡ (ä¼˜å…ˆçº§ 0-2)
ip link add link eth0 name eth0.1 type vlan id 1

# VLAN 2: å®æ—¶æµé‡ (ä¼˜å…ˆçº§ 3-5)
ip link add link eth0 name eth0.2 type vlan id 2

# VLAN 3: æ™®é€šæµé‡ (ä¼˜å…ˆçº§ 6-7)
ip link add link eth0 name eth0.3 type vlan id 3

ip link set eth0.1 up
ip link set eth0.2 up
ip link set eth0.3 up
```

#### Step 2: åˆ›å»ºé˜Ÿåˆ—å­¦ç§‘ (Qdisc)

```bash
#!/bin/bash
# tsn_setup.sh

# æ¸…é™¤ç°æœ‰é…ç½®
tc qdisc del dev eth0 root 2>/dev/null

# åˆ›å»º taprio è°ƒåº¦å™¨ (Time-Aware Priority Shaper)
# å‚æ•°è§£é‡Š:
#   num_tc 8: 8 ä¸ªæµé‡ç­‰çº§ (ä¼˜å…ˆçº§ 0-7)
#   queues: æ¯ä¸ªä¼˜å…ˆçº§ä¸€ä¸ªé˜Ÿåˆ—
#   base-time: è°ƒåº¦åŸºç¡€æ—¶é—´ (PTP æ—¶é—´)
#   sched-entry: é—¨ç¦æ¡ç›®

tc qdisc replace dev eth0 root taprio \
  num_tc 8 \
  map 0 1 2 3 4 5 6 7 \
  queues 1@0 1@1 1@2 1@3 1@4 1@5 1@6 1@7 \
  base-time 1705715200000000000 \
  sched-entry S 0x00FF 100000 \
  sched-entry S 0xFF00 900000 \
  clockid CLOCK_TAI \
  txtime-delay 0 \
  etf offload on

# æ³¨è§£:
# base-time: 0x1705715200000000000 = 2026-01-20 00:00:00.000000000 (çº³ç§’)
# sched-entry S 0x00FF 100000: æ—¶é—´æ§½ 0-100Âµs, é˜Ÿåˆ— 0-7 æ‰“å¼€ (FF = 11111111)
# sched-entry S 0xFF00 900000: æ—¶é—´æ§½ 100-1000Âµs, æ‰€æœ‰é˜Ÿåˆ—æ‰“å¼€
```

#### Step 3: é…ç½®æµè¿‡æ»¤ (tc flower)

```bash
#!/bin/bash
# ä¸ºä¸åŒçš„åº”ç”¨åˆ›å»ºæµåˆ†ç±»

# æµ 1: ç”µæœºæ§åˆ¶æŒ‡ä»¤ (UDP ç«¯å£ 5000, ä¼˜å…ˆçº§ 0)
tc filter add dev eth0 parent 1: protocol ip prio 1 \
  flower ip_proto udp dst_port 5000 \
  action skbedit prio 0

# æµ 2: ä¼ æ„Ÿå™¨æ•°æ® (UDP ç«¯å£ 5001-5008, ä¼˜å…ˆçº§ 2)
tc filter add dev eth0 parent 1: protocol ip prio 2 \
  flower ip_proto udp dst_port 5001-5008 \
  action skbedit prio 2

# æµ 3: è§†é¢‘æµ (UDP ç«¯å£ 5010-5020, ä¼˜å…ˆçº§ 6)
tc filter add dev eth0 parent 1: protocol ip prio 3 \
  flower ip_proto udp dst_port 5010-5020 \
  action skbedit prio 6

# é»˜è®¤: å…¶ä»–æµé‡ä¼˜å…ˆçº§ 7
tc filter add dev eth0 parent 1: protocol ip prio 999 \
  flower \
  action skbedit prio 7
```

#### Step 4: é…ç½®é€Ÿç‡é™åˆ¶ (å¯é€‰)

```bash
#!/bin/bash
# ä½¿ç”¨ tbf (Token Bucket Filter) é™åˆ¶é€Ÿç‡

# é™åˆ¶ä¼ æ„Ÿå™¨æµä¸º 10 Mbps
tc filter add dev eth0 parent 1: protocol ip prio 10 \
  flower ip_proto udp dst_port 5001-5008 \
  action police rate 10mbit burst 10k drop

# é™åˆ¶è§†é¢‘æµä¸º 50 Mbps
tc filter add dev eth0 parent 1: protocol ip prio 11 \
  flower ip_proto udp dst_port 5010-5020 \
  action police rate 50mbit burst 50k drop
```

#### Step 5: ç›‘æ§å’Œè°ƒè¯•

```bash
#!/bin/bash
# æŸ¥çœ‹é˜Ÿåˆ—çŠ¶æ€
tc qdisc show dev eth0

# æŸ¥çœ‹è¿‡æ»¤å™¨è§„åˆ™
tc filter show dev eth0

# å®æ—¶ç›‘æ§é˜Ÿåˆ—å»¶è¿Ÿ
watch -n 1 'tc -s qdisc show dev eth0'

# æŸ¥çœ‹ taprio è°ƒåº¦è¡¨
tc qdisc show dev eth0 root

# è·å– ethtool ç»Ÿè®¡
ethtool -S eth0 | grep -i queue
```

---

## ğŸ› ï¸ ç¡¬ä»¶æ”¯æŒå’Œå…¼å®¹æ€§

### æ”¯æŒçš„äº¤æ¢æœº

```
äº¤æ¢æœº              TSN æ”¯æŒ      æˆç†Ÿåº¦      æ¨èåº¦
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Marvell 88E6190    âœ… å®Œæ•´       ç”Ÿäº§çº§      â­â­â­â­â­
Marvell 88E6095    âœ… å®Œæ•´       ç”Ÿäº§çº§      â­â­â­â­
Realtek RTL8365SE  âš ï¸ éƒ¨åˆ†      alpha       âš ï¸ éœ€éªŒè¯
Broadcom 53134    âœ… å®Œæ•´       ç”Ÿäº§çº§      â­â­â­â­
Intel i210        âš ï¸ ä»…æ ‡ç­¾    æˆç†Ÿ         âš ï¸ æœ‰é™
```

### NIC (ç½‘å¡) æ”¯æŒ

```
NIC é©±åŠ¨            åŠŸèƒ½
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Intel igb          802.1Qav, æ—¶é—´æˆ³, taprio æ”¯æŒ
Realtek r8169      åŸºæœ¬æ”¯æŒ
Broadcom bnx2x     å®Œæ•´ TSN
Marvell pxa168     å®Œæ•´ TSN
```

### éªŒè¯æ­¥éª¤

```bash
# 1. æ£€æŸ¥ kernel ç‰ˆæœ¬ (éœ€è¦ 5.10+)
uname -r

# 2. æ£€æŸ¥ taprio æ”¯æŒ
modinfo sched_taprio

# 3. æ£€æŸ¥ ethtool ç‰¹æ€§
ethtool -T eth0 | grep -i time

# 4. æ£€æŸ¥ç¡¬ä»¶æ—¶é—´æˆ³
ethtool -T eth0 | grep -i hardware
```

---

## ğŸ“Š æ€§èƒ½åˆ†æ

### å»¶è¿Ÿé¢„æµ‹æ¨¡å‹

å¯¹äºç»™å®šçš„é…ç½®ï¼Œå¯ä»¥é¢„æµ‹æœ€åæƒ…å†µå»¶è¿Ÿï¼š

```
æœ€åæƒ…å†µå»¶è¿Ÿ (WCD) = 
    ç­‰å¾…æ—¶é—´ (å…¥é˜Ÿå»¶è¿Ÿ) 
    + ä¼ è¾“æ—¶é—´ (å¸§å‘é€æ—¶é—´)
    + ç½‘ç»œä¼ æ’­å»¶è¿Ÿ

ç­‰å¾…æ—¶é—´ = æœ€å¤šç­‰åˆ°ä¸‹ä¸€ä¸ªæ‰“å¼€çª—å£
        = å‘¨æœŸ - min_gate_duration
        â‰¤ 1ms (å¯¹äº 1ms å‘¨æœŸ)

ä¼ è¾“æ—¶é—´ = å¸§é•¿åº¦ Ã— 8 / é“¾æ¥é€Ÿç‡
        = 1500 bytes Ã— 8 / 1Gbps
        â‰ˆ 12 Âµs

ç½‘ç»œä¼ æ’­ = ç½‘ç»œå»¶è¿Ÿ + PTP åŒæ­¥è¯¯å·®
        â‰ˆ 0.5 Âµs (æœ¬åœ°) æˆ– 5 Âµs (è¿œç¨‹)

æ€» WCD â‰ˆ 1000 + 12 + 5 = 1017 Âµs
```

### ååé‡åˆ†æ

```
å‡è®¾:
- 1 Gbps é“¾æ¥
- ä¼˜å…ˆçº§ 0 (å…³é”®) å ç”¨ 100 Âµs / 1000 Âµs = 10%
- ä¼˜å…ˆçº§ 1-2 (å®æ—¶) å ç”¨ 400 Âµs / 1000 Âµs = 40%
- ä¼˜å…ˆçº§ 3-7 (æ™®é€š) å ç”¨ 500 Âµs / 1000 Âµs = 50%

ååé‡åˆ†é…:
- å…³é”®: 10% Ã— 1Gbps = 100 Mbps
- å®æ—¶: 40% Ã— 1Gbps = 400 Mbps
- æ™®é€š: 50% Ã— 1Gbps = 500 Mbps
```

---

## ğŸ¨ åº”ç”¨æ¡ˆä¾‹ï¼šå¤šæºè§†é¢‘ + å®æ—¶æ§åˆ¶

### åœºæ™¯

åŒæ—¶è¿è¡Œ:
- 1 ä¸ªé«˜åˆ†è¾¨ç‡è§†é¢‘æµ (1080p @ 30Hz, ~120 Mbps)
- 4 ä¸ª 1kHz ç”µæœºæ§åˆ¶æµ (æ¯ä¸ª ~100 kbps, æ€»è®¡ ~400 kbps)
- 8 ä¸ª 10Hz ä¼ æ„Ÿå™¨æµ (æ¯ä¸ª ~10 kbps, æ€»è®¡ ~80 kbps)
- ç½‘ç»œç®¡ç†æµé‡ (<5 Mbps)

### é…ç½®æ–¹æ¡ˆ

```
å‘¨æœŸ: 1 ms

æ—¶é—´æ§½ 0 (0-50Âµs):  
  â””â”€ ç”µæœºæ§åˆ¶ (ä¼˜å…ˆçº§ 0)
  â””â”€ æœ€å¤§å¸§: 68 å­—èŠ‚ Ã— 4 è·¯ = 272 å­—èŠ‚
  â””â”€ ä¼ è¾“æ—¶é—´: ~2.2 Âµs < 50 Âµs âœ“

æ—¶é—´æ§½ 1 (50-150Âµs):
  â””â”€ ä¼ æ„Ÿå™¨æ•°æ® (ä¼˜å…ˆçº§ 1-2)
  â””â”€ æœ€å¤§å¸§: 128 å­—èŠ‚ Ã— 8 è·¯ = 1024 å­—èŠ‚
  â””â”€ ä¼ è¾“æ—¶é—´: ~8.2 Âµs < 100 Âµs âœ“

æ—¶é—´æ§½ 2 (150-1000Âµs):
  â””â”€ è§†é¢‘æµ (ä¼˜å…ˆçº§ 6)
  â””â”€ å°½åŠ›è€Œä¸º (Best Effort)
  â””â”€ å¯ç”¨: 850 Âµs
  â””â”€ å¯ä¼ è¾“: 850 Ã— 1000 kbps = ~850 kbps
  â””â”€ éœ€è¦: 120 Mbps / 1000 = 120 kbps âœ“
```

### éªŒæ”¶æ ‡å‡†

```
æŒ‡æ ‡                    è¦æ±‚          éªŒè¯æ–¹æ³•
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ç”µæœºæ§åˆ¶å»¶è¿Ÿ            < 500 Âµs      å»¶è¿Ÿæµ‹é‡å·¥å…·
ç”µæœºæ§åˆ¶ä¸¢åŒ…ç‡          0             tcpdump éªŒè¯
ä¼ æ„Ÿå™¨é‡‡æ ·æŠ–åŠ¨          < 100 Âµs      æ—¶é—´æˆ³åˆ†æ
è§†é¢‘å¸§ç‡ç¨³å®šæ€§          Â±1%           è§†é¢‘åˆ†æå·¥å…·
æ€»ç³»ç»Ÿå»¶è¿Ÿ              < 2 ms        ç«¯åˆ°ç«¯æµ‹é‡
CPU å ç”¨ç‡              < 5%          top / pidstat
```

---

## ğŸ§ª æµ‹è¯•è®¡åˆ’

### Unit Tests

```python
# tests/test_tsn_core.py

def test_gate_schedule_creation():
    """æµ‹è¯•é—¨ç¦è¡¨åˆ›å»º"""
    schedule = TSNGateSchedule(
        cycle_time_us=1000,
        entries=[
            TSNGateEntry(0, 100, 0x0F),    # 0-100Âµs, é˜Ÿåˆ— 0-3
            TSNGateEntry(100, 900, 0xF0), # 100-1000Âµs, é˜Ÿåˆ— 4-7
        ]
    )
    assert len(schedule.entries) == 2
    assert schedule.cycle_time_us == 1000

def test_token_bucket_shaper():
    """æµ‹è¯•ä»¤æ¡¶æ•´å½¢å™¨"""
    shaper = TokenBucketShaper(
        cir=10000000,  # 10 Mbps
        cbs=1500,      # 1500 å­—èŠ‚
    )
    # å‘é€ 100 å­—èŠ‚çš„æ•°æ®åŒ…
    color = shaper.meter(100)
    assert color in [GREEN, YELLOW, RED]

def test_priority_queue_order():
    """æµ‹è¯•ä¼˜å…ˆçº§é˜Ÿåˆ—é¡ºåº"""
    queue = PriorityQueue()
    queue.enqueue(packet1, priority=7)  # ä½ä¼˜å…ˆçº§
    queue.enqueue(packet2, priority=0)  # é«˜ä¼˜å…ˆçº§
    
    first = queue.dequeue()
    assert first.priority == 0
```

### Integration Tests

```bash
# 1. å•æœºæµ‹è¯•ï¼šåŒä¸€ç‰©ç†ä¸»æœºä¸Šçš„å¤šä¸ªè™šæ‹Ÿ NIC
./test_tsn_single_host.sh

# 2. ç½‘ç»œæµ‹è¯•ï¼šä¸¤ä¸ªç‰©ç†ä¸»æœºé€šè¿‡äº¤æ¢æœº
./test_tsn_network_topology.sh

# 3. åº”åŠ›æµ‹è¯•ï¼šå…¨é€Ÿè¿è¡Œ 1 å°æ—¶
./test_tsn_stress_1hour.sh

# 4. æ•…éšœæµ‹è¯•ï¼šæ³¨å…¥åŒ…ä¸¢å¤±å’Œå»¶è¿Ÿ
./test_tsn_fault_injection.sh
```

### Performance Tests

```bash
# å»¶è¿Ÿåˆ†æ (ä½¿ç”¨ iperf3 + tcpdump)
./measure_tsn_latency.py \
    --duration 60 \
    --samples 10000 \
    --output latency_report.json

# ååé‡æµ‹è¯•
./measure_tsn_throughput.py \
    --duration 30 \
    --flow_count 10 \
    --output throughput_report.json

# é—¨ç¦è°ƒåº¦éªŒè¯ (ç”¨ hardware æ—¶é—´æˆ³)
./verify_gate_schedule.py \
    --schedule config.json \
    --duration 10 \
    --output gate_verification.json
```

---

## ğŸ“ é…ç½®æ–‡ä»¶æ ¼å¼

### YAML é…ç½®ç¤ºä¾‹

```yaml
# tsn_config.yaml

version: "1.0"
domain: "OpenNeuro-Motor"

clock:
  ptp_enabled: true
  grandmaster: "192.168.1.100"
  domain_number: 0

networks:
  - interface: "eth0"
    mtu: 1500
    speed: 1000  # Mbps
    
    vlans:
      - id: 1
        name: "critical"
        priority: 0-2
      
      - id: 2
        name: "isochronous"
        priority: 3-5
      
      - id: 3
        name: "best-effort"
        priority: 6-7
    
    gate_schedule:
      cycle_time_us: 1000
      base_time: "2026-01-20T00:00:00Z"
      entries:
        - time_slot: 0
          duration_us: 100
          gates: "0000_1111"  # é˜Ÿåˆ— 0-3 æ‰“å¼€
        
        - time_slot: 100
          duration_us: 900
          gates: "1111_0000"  # é˜Ÿåˆ— 4-7 æ‰“å¼€

streams:
  - id: "motor_cmd"
    source: "192.168.1.50"
    dest_port: 5000
    priority: 0
    max_latency_us: 500
    max_frame_size: 100
  
  - id: "sensor_data"
    source: "192.168.1.51"
    dest_port: 5001-5008
    priority: 2
    max_latency_us: 5000
    max_frame_size: 256
  
  - id: "video_stream"
    source: "192.168.1.52"
    dest_port: 5010-5020
    priority: 6
    max_latency_us: 33000  # è§†é¢‘å¸§æ—¶é—´
    bandwidth_kbps: 120000
```

---

## ğŸš€ éƒ¨ç½²å’Œæ“ä½œ

### éƒ¨ç½²æ£€æŸ¥æ¸…å•

- [ ] Linux kernel ç‰ˆæœ¬ â‰¥ 5.10
- [ ] iproute2 å·¥å…·åŒ… (tc, ip)
- [ ] taprio qdisc é©±åŠ¨ç¼–è¯‘
- [ ] äº¤æ¢æœºå›ºä»¶å‡çº§
- [ ] PTP æ—¶é—´åŒæ­¥éªŒè¯ (<10Âµs)
- [ ] ç½‘ç»œé…ç½®è„šæœ¬æµ‹è¯•
- [ ] ç›‘æ§å·¥å…·éƒ¨ç½²
- [ ] å‘Šè­¦è§„åˆ™é…ç½®
- [ ] å¤‡ä»½å’Œæ¢å¤è®¡åˆ’

### è¿ç»´å‘½ä»¤

```bash
# å¯åŠ¨ TSN è°ƒåº¦
sudo ./tsn_start.sh

# åœæ­¢ TSN è°ƒåº¦ (å›åˆ°æœ€ä½³å°½åŠ›)
sudo ./tsn_stop.sh

# æ£€æŸ¥ TSN çŠ¶æ€
./tsn_status.sh

# å®æ—¶ç›‘æ§
./tsn_monitor.py --interval 1 --output tsn_monitor.log

# æ•°æ®å¯¼å‡º
./tsn_export_stats.py --format json --output stats_$(date +%s).json
```

---

## ğŸ“š å‚è€ƒå’Œèµ„æº

### IEEE æ ‡å‡†

- IEEE 802.1AS: æ—¶é—´å’ŒåŒæ­¥æ–¹å‘è¡¨ç¤º
- IEEE 802.1Qbv: æ—¶é—´æ„ŸçŸ¥é—¨ç¦è°ƒåº¦
- IEEE 802.1Qci: Per-Stream Filtering and Policing
- IEEE 802.1Qcc: é…ç½®å’Œå…¼å®¹æ€§ç®¡ç†

### å¼€æºé¡¹ç›®

- Linux kernel qdisc subsystem (taprio)
- Open-vSwitch (OVS) - SDN å¼€å…³
- TSN tools (github.com/nxp-qoriq/)

### å­¦æœ¯è®ºæ–‡

- "Real-time Ethernet for Industrial Automation"
- "Deterministic Networking Achieves Gigabit Speeds"

---

**æ­¤æ–‡æ¡£ä¸º Stage 2 TSN å­é¡¹ç›®çš„è¯¦ç»†æŠ€æœ¯è§„èŒƒ**

ä¸‹ä¸€æ­¥: ä½¿ç”¨ Linux tc + taprio å®ç°åŸå‹

