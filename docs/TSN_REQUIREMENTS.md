# TSN Scheduler - éœ€æ±‚è§„æ ¼è¯´æ˜ä¹¦

## ğŸ“‹ æ–‡æ¡£æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†å®šä¹‰äº† OpenNeuro TSN (Time-Sensitive Networking) è°ƒåº¦å™¨çš„åŠŸèƒ½éœ€æ±‚ã€æ€§èƒ½æŒ‡æ ‡ã€çº¦æŸæ¡ä»¶å’Œç³»ç»Ÿæ¥å£ã€‚

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**åˆ›å»ºæ—¥æœŸ**: 2026å¹´1æœˆ20æ—¥  
**é¢„è®¡å®Œæˆ**: 2026å¹´2æœˆ16æ—¥

---

## 1. åŠŸèƒ½éœ€æ±‚

### 1.1 æ ¸å¿ƒåŠŸèƒ½

#### F1: æµé‡åˆ†ç±»ä¸ä¼˜å…ˆçº§ç®¡ç†
- **éœ€æ±‚**: æ”¯æŒå¯¹ç½‘ç»œæµé‡è¿›è¡Œåˆ†ç±»å’Œä¼˜å…ˆçº§è®¾ç½®
- **è¯¦ç»†è¯´æ˜**:
  - æ”¯æŒ 4-8 ä¸ªä¼˜å…ˆçº§ç­‰çº§ (Priority 0-7)
  - æ ¹æ® 802.1p CoS (Class of Service) å­—æ®µè¿›è¡Œåˆ†ç±»
  - æ”¯æŒ VLAN æ ‡ç­¾è¯†åˆ«
  - å¯ä¸ºæ¯ä¸ªä¼˜å…ˆçº§å®šä¹‰å¸¦å®½é¢„ç•™

**éªŒæ”¶æ ‡å‡†**:
```
âœ“ èƒ½å¤Ÿå¯¹ç½‘ç»œæŠ¥æ–‡è¿›è¡Œ 0-7 ä¼˜å…ˆçº§æ ‡è®°
âœ“ åŒä¸€ä¼˜å…ˆçº§çš„æŠ¥æ–‡åœ¨é˜Ÿåˆ—ä¸­ä¿æŒé¡ºåº
âœ“ å¸¦å®½é¢„ç•™è¯¯å·® < 5%
```

#### F2: æ—¶é—´æ„ŸçŸ¥é—¨æ§ (Time-Aware Gate Control)
- **éœ€æ±‚**: åŸºäºç²¾ç¡®æ—¶é—´æˆ³å®ç°ç¡®å®šæ€§çš„æŠ¥æ–‡è½¬å‘
- **è¯¦ç»†è¯´æ˜**:
  - ä½¿ç”¨ PTP æ—¶é—´åŒæ­¥ä½œä¸ºå‚è€ƒæ—¶é’Ÿ
  - é…ç½®æ—¶é—´è¡¨ (Schedule) æ§åˆ¶æ¯ä¸ªä¼˜å…ˆçº§çš„å¼€é—­
  - å‘¨æœŸæ€§åœ°å¼€é—­ä¸åŒä¼˜å…ˆçº§çš„"é—¨"
  - æ”¯æŒ 1ms ~ 1s çš„è°ƒåº¦å‘¨æœŸ

**éªŒæ”¶æ ‡å‡†**:
```
âœ“ é—¨æ§ç²¾åº¦ < 100Âµs
âœ“ æ¼åŒ…ç‡ < 0.1%
âœ“ æ”¯æŒå¤šè¾¾ 128 ä¸ªè°ƒåº¦äº‹ä»¶/å‘¨æœŸ
```

#### F3: ç¡®å®šæ€§å»¶è¿Ÿä¿è¯
- **éœ€æ±‚**: ä¸ºå®æ—¶æµé‡æä¾›å¯é¢„æµ‹çš„ç½‘ç»œå»¶è¿Ÿ
- **è¯¦ç»†è¯´æ˜**:
  - å¯¹ä¸åŒä¼˜å…ˆçº§çš„æŠ¥æ–‡æ‰¿è¯ºæœ€å¤§å»¶è¿Ÿæ—¶é—´
  - é«˜ä¼˜å…ˆçº§ (RT æµ): < 100Âµs
  - ä¸­ç­‰ä¼˜å…ˆçº§ (Control): < 1ms
  - ä½ä¼˜å…ˆçº§ (Best Effort): å°½åŠ›è€Œä¸º

**éªŒæ”¶æ ‡å‡†**:
```
âœ“ 99.99% çš„æŠ¥æ–‡æ»¡è¶³å»¶è¿Ÿæ‰¿è¯º
âœ“ æ— è¶…æœŸæŠ¥æ–‡è¢«ä¸¢å¼ƒ
âœ“ å¸¦å®½ä¸è¶…é…
```

#### F4: Linux tc/taprio é©±åŠ¨é›†æˆ
- **éœ€æ±‚**: ä¸ Linux å†…æ ¸çš„æ ‡å‡† QoS å·¥å…·é›†æˆ
- **è¯¦ç»†è¯´æ˜**:
  - é€šè¿‡ tc (traffic control) å‘½ä»¤é…ç½®è°ƒåº¦
  - æ”¯æŒ taprio qdisc (Time-Aware Priority Queuing)
  - å¯¼å‡ºå½“å‰é…ç½®ä¸ºå¯è¯»æ ¼å¼
  - æ”¯æŒçƒ­é‡è½½ (ä¸ä¸­æ–­ç°æœ‰æµé‡)

**éªŒæ”¶æ ‡å‡†**:
```
âœ“ tc qdisc add å‘½ä»¤èƒ½æˆåŠŸé…ç½®è°ƒåº¦
âœ“ é…ç½®ä¿®æ”¹åœ¨ 100ms å†…ç”Ÿæ•ˆ
âœ“ ç°æœ‰è¿æ¥ä¸ä¸­æ–­
```

### 1.2 å¯é€‰åŠŸèƒ½

#### F5: ç¡¬ä»¶äº¤æ¢æœºæ”¯æŒ
- **éœ€æ±‚**: ä¸æ”¯æŒ TSN çš„ç¡¬ä»¶äº¤æ¢æœºé›†æˆ
- æ”¯æŒäº¤æ¢æœº: Marvell 88E6190X, Microchip, ç­‰
- é€šè¿‡ IEEE 802.1Qbv æ ‡å‡†åŒ–æ¥å£é…ç½®

#### F6: Web ç®¡ç†ç•Œé¢
- **éœ€æ±‚**: æä¾›å›¾å½¢åŒ–çš„è°ƒåº¦é…ç½®ç•Œé¢
- å®æ—¶æ˜¾ç¤ºç½‘ç»œæ‹“æ‰‘å’Œæµé‡
- è°ƒåº¦è¡¨å¯è§†åŒ–
- æ€§èƒ½ç›‘æ§ä»ªè¡¨æ¿

#### F7: ç›‘æµ‹ä¸è¯Šæ–­
- **éœ€æ±‚**: å®æ—¶ç›‘æµ‹ TSN è°ƒåº¦çš„è¿è¡ŒçŠ¶æ€
- æ¯ä¸ªä¼˜å…ˆçº§çš„æŠ¥æ–‡è®¡æ•°
- å»¶è¿Ÿç›´æ–¹å›¾
- ä¸¢åŒ…ç»Ÿè®¡
- æ‹¥å¡å‘Šè­¦

---

## 2. æ€§èƒ½éœ€æ±‚

### 2.1 å»¶è¿Ÿæ€§èƒ½

| æµé‡ç±»å‹ | æœ€å¤§å»¶è¿Ÿ | æŠ–åŠ¨ (Jitter) | ä¸¢åŒ…ç‡ |
|---------|---------|--------------|--------|
| **å®æ—¶æ§åˆ¶** (Priority 7) | <100Âµs | <20Âµs | <0.01% |
| **è§†é¢‘æµ** (Priority 5-6) | <1ms | <100Âµs | <0.1% |
| **éŸ³é¢‘æµ** (Priority 4) | <10ms | <1ms | <0.1% |
| **æœ€ä½³åŠªåŠ›** (Priority 0-3) | æ— ä¿è¯ | æ— ä¿è¯ | <1% |

### 2.2 ååé‡æ€§èƒ½

- **æ€»ååé‡**: 2 Gbps (å¯¹äºåŒ Gigabit æ¥å£)
- **å¸¦å®½å¯ç”¨æ€§**: 95% (5% ç”¨äºå¼€é”€)
- **æ¯ä¸ªä¼˜å…ˆçº§å¯é…ç½®ç‹¬ç«‹å¸¦å®½**

### 2.3 æ‰©å±•æ€§

- **æ”¯æŒä¼˜å…ˆçº§æ•°**: 4-8 ä¸ª
- **æ”¯æŒç«¯å£æ•°**: 2-4 ä¸ªæœ‰çº¿æ¥å£
- **è°ƒåº¦è¡¨å¤§å°**: æœ€å°‘ 128 ä¸ªäº‹ä»¶/å‘¨æœŸ
- **é…ç½®ä¿®æ”¹æ—¶é—´**: <100ms (çƒ­é‡è½½)

### 2.4 å¯é æ€§

- **è¿è¡Œæ—¶é—´**: æ”¯æŒè¿ç»­è¿è¡Œ 30+ å¤©æ— æ•…éšœ
- **å¹³å‡æ•…éšœé—´éš”** (MTBF): >10,000 å°æ—¶
- **æ•…éšœè‡ªæ¢å¤**: é…ç½®ç¼“å­˜ç¡®ä¿é‡å¯åæ¢å¤

---

## 3. æ¥å£è§„èŒƒ

### 3.1 ç½‘ç»œæ¥å£

#### ç‰©ç†æ¥å£
- **æ¥å£ç±»å‹**: Gigabit Ethernet (1000 Base-T)
- **è¿æ¥å™¨**: RJ-45
- **åè®®**: IEEE 802.3
- **åŒæ­¥æ—¶é’Ÿ**: PTP (IEEE 1588 v2)

#### é€»è¾‘æ¥å£
- **MTU (Maximum Transmission Unit)**: 1500 å­—èŠ‚
- **VLAN æ”¯æŒ**: 802.1Q (å¸¦æ ‡ç­¾)
- **CoS æ ‡ç­¾**: 802.1p (3 bits)
- **æ—¶é—´æˆ³ç²¾åº¦**: Â±10Âµs

### 3.2 é…ç½®æ¥å£

#### Linux tc å‘½ä»¤
```bash
# æ·»åŠ  taprio è°ƒåº¦å™¨
tc qdisc add dev eth0 parent root \
  taprio num_tc 4 map 0 1 2 3 \
  queues 1@0 1@1 1@2 1@3 \
  base-time 0 clockid CLOCK_TAI \
  sched-entry S 0f 100000000 \
  sched-entry S 0e 100000000 \
  sched-entry S 0c 100000000 \
  sched-entry S 00 100000000

# æŸ¥çœ‹å½“å‰é…ç½®
tc -d qdisc show dev eth0

# åˆ é™¤è°ƒåº¦å™¨
tc qdisc del dev eth0 parent root
```

#### ç¼–ç¨‹æ¥å£ (C/Python)
```c
// C API
typedef struct {
    uint8_t  num_queues;           // é˜Ÿåˆ—æ•°é‡
    uint8_t  num_gates;            // é—¨æ§æ•°é‡
    uint64_t base_time;            // åŸºå‡†æ—¶é—´ (nanoseconds)
    uint64_t cycle_time;           // å‘¨æœŸæ—¶é—´
    struct {
        uint8_t  priority;         // ä¼˜å…ˆçº§
        uint32_t gate_mask;        // å¼€é—­é—¨æ§ä½æ©ç 
        uint32_t duration;         // æ—¶é—´æ®µæŒç»­æ—¶é—´ (ns)
    } gates[128];
} tsn_config_t;

int tsn_configure(const char *ifname, const tsn_config_t *config);
int tsn_get_config(const char *ifname, tsn_config_t *config);
int tsn_apply_config(const char *ifname);
```

### 3.3 ç›‘æµ‹æ¥å£

```c
// æŸ¥è¯¢æµé‡ç»Ÿè®¡
typedef struct {
    uint64_t packets_in;           // å…¥ç«™æŠ¥æ–‡æ•°
    uint64_t packets_out;          // å‡ºç«™æŠ¥æ–‡æ•°
    uint64_t bytes_in;             // å…¥ç«™å­—èŠ‚æ•°
    uint64_t bytes_out;            // å‡ºç«™å­—èŠ‚æ•°
    uint64_t packets_dropped;      // ä¸¢å¼ƒçš„æŠ¥æ–‡æ•°
    uint32_t avg_latency_us;       // å¹³å‡å»¶è¿Ÿ (å¾®ç§’)
    uint32_t max_latency_us;       // æœ€å¤§å»¶è¿Ÿ
    uint32_t min_latency_us;       // æœ€å°å»¶è¿Ÿ
} tsn_stats_t;

int tsn_get_stats(const char *ifname, uint8_t priority, 
                  tsn_stats_t *stats);
```

---

## 4. çº¦æŸæ¡ä»¶

### 4.1 ç¡¬ä»¶çº¦æŸ

- **æœ€å°æ”¯æŒå¹³å°**: RK3588 æˆ–ç­‰æ•ˆ ARM å¤„ç†å™¨
- **æœ€å°å†…å­˜**: 256MB RAM (è¿è¡Œæ—¶)
- **ç½‘ç»œæ¥å£**: è‡³å°‘ 1 ä¸ª Gigabit Ethernet (å»ºè®® 2 ä¸ª)
- **æ—¶é’Ÿç²¾åº¦**: æ”¯æŒ PTP åŒæ­¥è‡³ <10Âµs ç²¾åº¦

### 4.2 è½¯ä»¶çº¦æŸ

- **æ“ä½œç³»ç»Ÿ**: Linux 5.15+
- **å†…æ ¸æ”¯æŒ**: CONFIG_NET_SCHED_TAPRIO
- **PTP åŒæ­¥**: éœ€è¦ ptp4l æˆ–ç­‰æ•ˆæœåŠ¡è¿è¡Œ
- **ä¾èµ–åº“**: libnl, libnetlink

### 4.3 ç½‘ç»œçº¦æŸ

- **ç½‘ç»œæ‹“æ‰‘**: æ˜Ÿå½¢æˆ–ç¯å½¢
- **ç½‘ç»œè®¾å¤‡**: æ”¯æŒ 802.1Qbv çš„äº¤æ¢æœº (å¯é€‰)
- **æ—¶é—´åŒæ­¥ç²¾åº¦**: Â±10Âµs (ç”± PTP æä¾›)

### 4.4 åº”ç”¨çº¦æŸ

- **æœ€å¤§ç«¯å£æ•°**: 4
- **æœ€å¤§ä¼˜å…ˆçº§æ•°**: 8
- **è°ƒåº¦å‘¨æœŸ**: 1ms - 1s
- **æœ€å¤šè°ƒåº¦äº‹ä»¶**: 128 ä¸ª/å‘¨æœŸ

---

## 5. ä½¿ç”¨åœºæ™¯

### åœºæ™¯ 1: æœºå™¨äººå¤šè½´ååŠ¨

**èƒŒæ™¯**: å¤šè‡‚æœºå™¨äººéœ€è¦å„è½´ç”µæœºåœ¨å¾®ç§’çº§ç²¾åº¦åŒæ­¥

**éœ€æ±‚**:
- 4 ä¸ªå®æ—¶æ§åˆ¶æµ (ç”µæœºæŒ‡ä»¤)ï¼Œå»¶è¿Ÿ <100Âµs
- 1 ä¸ªè§†é¢‘æµ (è§†è§‰åé¦ˆ)ï¼Œå»¶è¿Ÿ <10ms
- 1 ä¸ªç®¡ç†æµ (ä¸éœ€æ—¶é—´ä¿è¯)

**é…ç½®ç¤ºä¾‹**:
```
ä¼˜å…ˆçº§ 7: ç”µæœºæ§åˆ¶ (100Âµs, ç‹¬å  200 Mbps)
ä¼˜å…ˆçº§ 6: ä¼ æ„Ÿå™¨åé¦ˆ (1ms, ç‹¬å  100 Mbps)
ä¼˜å…ˆçº§ 4: è§†é¢‘æµ (10ms, ç‹¬å  500 Mbps)
ä¼˜å…ˆçº§ 0: æœ€ä½³åŠªåŠ› (å‰©ä½™ 700 Mbps)
```

### åœºæ™¯ 2: éŸ³è§†é¢‘ç¼–è§£ç ç³»ç»Ÿ

**éœ€æ±‚**:
- éŸ³é¢‘æµï¼š< 1ms å»¶è¿Ÿï¼Œç¡®å®šæ€§
- è§†é¢‘æµï¼š< 33ms å»¶è¿Ÿ (30fps)
- ç½‘ç»œæ§åˆ¶ï¼š<10ms å»¶è¿Ÿ

### åœºæ™¯ 3: å·¥ä¸šæ§åˆ¶ç½‘ç»œ

**éœ€æ±‚**:
- EtherCAT å®æ—¶æµï¼š< 100Âµs
- ä¼ æ„Ÿå™¨æ•°æ®ï¼š< 10ms
- è¯Šæ–­å’Œé…ç½®ï¼šæœ€ä½³åŠªåŠ›

---

## 6. æµ‹è¯•éœ€æ±‚

### 6.1 åŠŸèƒ½æµ‹è¯•

- æµé‡åˆ†ç±»çš„æ­£ç¡®æ€§
- ä¼˜å…ˆçº§éš”ç¦» (é«˜ä¼˜å…ˆçº§ä¸å½±å“ä½ä¼˜å…ˆçº§)
- å¸¦å®½é¢„ç•™çš„å‡†ç¡®æ€§
- é—¨æ§æ—¶åºçš„ç²¾åº¦

### 6.2 æ€§èƒ½æµ‹è¯•

- å»¶è¿Ÿåˆ†å¸ƒæµ‹é‡ (ä½¿ç”¨ iPerf æˆ–è‡ªå®šä¹‰å·¥å…·)
- ååé‡æµ‹è¯• (æœ€å¤§æ‰¿è½½èƒ½åŠ›)
- é•¿æœŸç¨³å®šæ€§ (24h+ è¿ç»­è¿è¡Œ)
- çƒ­é‡è½½æ€§èƒ½ (é…ç½®ä¿®æ”¹æ—¶çš„å½±å“)

### 6.3 å¯é æ€§æµ‹è¯•

- ç½‘ç»œæŠ–åŠ¨æ¢å¤èƒ½åŠ›
- æ—¶é’Ÿçªå˜æ—¶çš„è¡Œä¸º
- å¼‚å¸¸æµé‡å¤„ç† (è¶…é…ã€çˆ†å‘)

---

## 7. æ–‡æ¡£è¦æ±‚

### 7.1 å¼€å‘æ–‡æ¡£

- [ ] æ¶æ„è®¾è®¡æ–‡æ¡£
- [ ] API å‚è€ƒæ‰‹å†Œ
- [ ] ç®—æ³•è®¾è®¡è¯´æ˜ (è°ƒåº¦ç®—æ³•ã€æµé‡ç®¡ç†)
- [ ] ä»£ç æ³¨é‡Š (>80% è¦†ç›–ç‡)

### 7.2 ç”¨æˆ·æ–‡æ¡£

- [ ] å¿«é€Ÿå¼€å§‹æŒ‡å—
- [ ] é…ç½®å‚è€ƒæ‰‹å†Œ
- [ ] æ•…éšœæ’é™¤æŒ‡å—
- [ ] æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 7.3 æµ‹è¯•æ–‡æ¡£

- [ ] æµ‹è¯•è®¡åˆ’
- [ ] æµ‹è¯•ç”¨ä¾‹é›†
- [ ] æ€§èƒ½åŸºå‡†æŠ¥å‘Š

---

## 8. éªŒæ”¶æ ‡å‡†

| éœ€æ±‚ | éªŒæ”¶æ ‡å‡† | çŠ¶æ€ |
|------|---------|------|
| æµé‡åˆ†ç±» | æ”¯æŒ 4+ ä¼˜å…ˆçº§ï¼Œå‡†ç¡®ç‡ 100% | âœ… è®¡åˆ’ |
| å»¶è¿Ÿæ€§èƒ½ | RT æµ <100Âµsï¼Œ99.99% æ»¡è¶³ | âœ… è®¡åˆ’ |
| ååé‡ | 2 Gbps 95% å¯ç”¨ | âœ… è®¡åˆ’ |
| Linux é›†æˆ | tc/taprio å‘½ä»¤å®Œå…¨æ”¯æŒ | âœ… è®¡åˆ’ |
| æ–‡æ¡£å®Œæ•´æ€§ | API æ–‡æ¡£ + ç”¨æˆ·æ‰‹å†Œ | âœ… è®¡åˆ’ |
| æµ‹è¯•è¦†ç›– | å•å…ƒæµ‹è¯• + é›†æˆæµ‹è¯• + æ€§èƒ½æµ‹è¯• | âœ… è®¡åˆ’ |

---

## 9. å¼€å‘é‡Œç¨‹ç¢‘

| å‘¨ | ä»»åŠ¡ | äº¤ä»˜ç‰© |
|----|------|--------|
| W1-W2 | éœ€æ±‚åˆ†æ + ç³»ç»Ÿè®¾è®¡ | æœ¬æ–‡æ¡£ |
| W3-W4 | éœ€æ±‚è¯„å®¡ + ç®—æ³•è®¾è®¡ | ç®—æ³•è¯´æ˜æ–‡æ¡£ |
| W5-W6 | æ ¸å¿ƒæ¨¡å—å¼€å‘ | æµé‡åˆ†ç±» + å¸¦å®½ç®¡ç† |
| W7-W8 | Linux é©±åŠ¨é›†æˆ | tc/taprio æ¥å£ |
| W9 | ç¡¬ä»¶äº¤æ¢æœºæ”¯æŒ (å¯é€‰) | äº¤æ¢æœºé©±åŠ¨ |
| W10-W12 | é›†æˆä¸æµ‹è¯• | å®Œæ•´ç³»ç»ŸéªŒè¯ |
| W13-W15 | æ€§èƒ½ä¼˜åŒ–ä¸æ–‡æ¡£ | æœ€ç»ˆæ–‡æ¡£ + æ€§èƒ½æŠ¥å‘Š |

---

## 10. é£é™©ä¸ç¼“è§£

| é£é™© | å½±å“ | æ¦‚ç‡ | ç¼“è§£æªæ–½ |
|------|------|------|---------|
| PTP æ—¶é’Ÿæ¼‚ç§» | å»¶è¿Ÿç²¾åº¦ä¸‹é™ | ä¸­ | æ”¹è¿› PTP ç®—æ³•ï¼Œå¢åŠ åŒæ­¥é¢‘ç‡ |
| Linux å†…æ ¸ä¸æ”¯æŒ | æ— æ³•éƒ¨ç½² | ä½ | å‡çº§å†…æ ¸æˆ–è‡ªå®šä¹‰é©±åŠ¨ |
| ç½‘ç»œæŠ–åŠ¨å¤§ | æ— æ³•æ»¡è¶³å»¶è¿Ÿæ‰¿è¯º | ä¸­ | ä½¿ç”¨é«˜è´¨é‡ç½‘ç»œè®¾å¤‡ |
| æµé‡çªå¢ | ä¼˜å…ˆçº§éš”ç¦»å¤±æ•ˆ | ä¸­ | å®ç°æµé‡æ•´å½¢å’Œå‘Šè­¦æœºåˆ¶ |

---

**ä¸‹ä¸€æ­¥**: ç»„ç»‡éœ€æ±‚è¯„å®¡ä¼šè®® (2026å¹´1æœˆ27æ—¥)ï¼Œè®¡åˆ’ 2026å¹´2æœˆ2æ—¥å¯åŠ¨è¯¦ç»†è®¾è®¡ã€‚

**è¯„å®¡æ¸…å•**:
- [ ] éœ€æ±‚çš„å®Œæ•´æ€§å’Œæ˜ç¡®æ€§
- [ ] æ€§èƒ½æŒ‡æ ‡çš„å¯è¾¾æˆæ€§
- [ ] çº¦æŸæ¡ä»¶çš„åˆç†æ€§
- [ ] é£é™©è¯†åˆ«çš„å……åˆ†æ€§
