# PTP Protocol Stack - æž¶æž„è®¾è®¡æ–‡æ¡£

## ðŸ“‹ æ–‡æ¡£æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†æè¿°äº† OpenNeuro PTP (IEEE 1588 v2) åè®®æ ˆçš„å®Œæ•´æž¶æž„è®¾è®¡ï¼ŒåŒ…æ‹¬ç³»ç»Ÿåˆ†å±‚ã€æ ¸å¿ƒç®—æ³•ã€çŠ¶æ€æœºè®¾è®¡å’Œè·¨å¹³å°é€‚é…æ–¹æ¡ˆã€‚

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**åˆ›å»ºæ—¥æœŸ**: 2026å¹´1æœˆ20æ—¥  
**é¢„è®¡å®Œæˆ**: 2026å¹´2æœˆ2æ—¥

---

## ðŸ—ï¸ ç³»ç»Ÿæž¶æž„

### åˆ†å±‚è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     åº”ç”¨å±‚ (Application)             â”‚
â”‚  ç”¨æˆ·åº”ç”¨ / ROS 2 é›†æˆ               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     API å±‚ (Public API)               â”‚
â”‚  ptp_init() / ptp_step() / ptp_get() â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     åè®®å±‚ (PTP Protocol Core)        â”‚
â”‚  State Machine / Messages / Servo     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     å¹³å°å±‚ (Platform Abstraction)     â”‚
â”‚  Timestamp / Network / Timer         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     ç¡¬ä»¶å±‚ (Hardware Drivers)         â”‚
â”‚  STM32H7 / RK3588 / ESP32          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒæ¨¡å—

#### 1. çŠ¶æ€æœºæ¨¡å— (State Machine)

**Master æ¨¡å¼çŠ¶æ€æœº:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  INITIALIZING  â—„â”€â”€â”€â”€â”€â”
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  LISTENING                     â”‚
    â”‚  (ç­‰å¾…æˆä¸º Master æˆ– Slave)    â”‚
    â”‚  - ç›‘å¬ ANNOUNCE æ¶ˆæ¯          â”‚
    â”‚  - æ¯”è¾ƒ Clock Identity         â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  MASTER                        â”‚
    â”‚  (æ—¶é’Ÿæº)                      â”‚
    â”‚  - å‘é€ SYNC æ¶ˆæ¯              â”‚
    â”‚  - å¤„ç† DELAY_REQ              â”‚
    â”‚  - ç»´æŠ¤æ—¶é—´                    â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  SLAVE                         â”‚
    â”‚  (è·Ÿéš Master)                 â”‚
    â”‚  - æŽ¥æ”¶ SYNC æ¶ˆæ¯              â”‚
    â”‚  - å‘é€ DELAY_REQ              â”‚
    â”‚  - è°ƒæ•´æœ¬åœ°æ—¶é’Ÿ                â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**çŠ¶æ€è½¬ç§»æ¡ä»¶:**
- INITIALIZING â†’ LISTENING: åˆå§‹åŒ–å®Œæˆ
- LISTENING â†’ MASTER: èµ¢å¾— BMC (Best Master Clock) ç®—æ³•
- LISTENING â†’ SLAVE: è¯†åˆ«æ›´å¥½çš„ Master
- MASTER â†” SLAVE: PTP åŸŸå†…æ—¶é’Ÿæ¯”è¾ƒ

#### 2. æ¶ˆæ¯å¤„ç†æ¨¡å— (Message Handler)

**æ”¯æŒçš„æ¶ˆæ¯ç±»åž‹:**

| æ¶ˆæ¯ | æ–¹å‘ | ç”¨é€” | å‘¨æœŸ |
|------|------|------|------|
| ANNOUNCE | Master â†’ All | å®£å‘Šè‡ªå·±ä¸ºæ—¶é’Ÿæº | 1-16s |
| SYNC | Master â†’ Slave | ä¸»æ—¶é’ŸåŒæ­¥ | 1-128ms |
| FOLLOW_UP | Master â†’ Slave | SYNC å‘é€æ—¶é—´æˆ³ | åŒ SYNC |
| DELAY_REQ | Slave â†’ Master | æµ‹é‡å¾€è¿”å»¶è¿Ÿ | 1-128s |
| DELAY_RESP | Master â†’ Slave | è¿”å›žå»¶è¿Ÿå“åº” | åŒ DELAY_REQ |
| PDELAY_REQ | P2Pæ¨¡å¼ | ç‚¹å¯¹ç‚¹å»¶è¿Ÿæµ‹é‡ | 1-128s |
| PDELAY_RESP | P2Pæ¨¡å¼ | ç‚¹å¯¹ç‚¹å»¶è¿Ÿå“åº” | åŒ PDELAY_REQ |

**æ¶ˆæ¯æ ¼å¼ (IEEE 1588 v2):**
```c
struct ptp_header {
    uint8_t  transport_specific;   // 4 bits: PTP_OVER_UDP_IPV4 = 0
    uint8_t  message_type;         // 4 bits: SYNC, FOLLOW_UP, ç­‰
    uint8_t  version_ptp;          // 4 bits: PTP v2.0 = 2
    uint8_t  minor_version;        // 4 bits: 0
    uint16_t message_length;       // æ¶ˆæ¯æ€»é•¿åº¦
    uint8_t  domain_number;        // PTP åŸŸå· (é»˜è®¤ 0)
    uint8_t  flags[2];             // æ ‡å¿—ä½
    int64_t  correction_field;     // è·¯å¾„å»¶è¿Ÿè¡¥æ­£
    uint32_t source_port_id[3];    // æºç«¯å£æ ‡è¯†ç¬¦
    uint16_t sequence_id;          // åºåˆ—å·
    uint8_t  control;              // æŽ§åˆ¶å­—æ®µ
    uint8_t  log_message_interval; // æ¶ˆæ¯é—´éš” (2^n ms)
};
```

#### 3. Servo æ¨¡å— (æ—¶é’ŸæŽ§åˆ¶)

ä½¿ç”¨ **PI (Proportional-Integral) Servo ç®—æ³•** è°ƒæ•´æœ¬åœ°æ—¶é’Ÿï¼š

```
è¯¯å·® (nanoseconds)
     â”‚
     â”œâ”€â”€â–º Proportional å¢žç›Š (KP)
     â”‚
     â”œâ”€â”€â–º Integral å¢žç›Š (KI)  â”€â”€â–º é¢‘çŽ‡è°ƒæ•´ (PPM)
     â”‚
     â””â”€â”€â–º é™åˆ¶å™¨ (Limiter)
           - æœ€å¤§ Â±500 PPM
           - ç¼“æ…¢æ”¶æ•› (é˜²æ­¢æ—¶é’Ÿè·³è·ƒ)
```

**Servo ä¼ªä»£ç :**
```c
// æ¯æ¬¡æ”¶åˆ° SYNC æ¶ˆæ¯åŽæ‰§è¡Œ
void servo_step(ptp_state_t *state, int64_t time_error_ns) {
    // è®¡ç®— PI è¾“å‡º
    int32_t proportional = KP * time_error_ns;
    state->integral_sum += time_error_ns;
    int32_t integral = KI * state->integral_sum;
    
    // é¢‘çŽ‡è°ƒæ•´ (PPM)
    int32_t freq_adj_ppm = (proportional + integral) / NORM;
    
    // é™åˆ¶é¢‘çŽ‡è°ƒæ•´èŒƒå›´
    if (freq_adj_ppm > 500) freq_adj_ppm = 500;
    if (freq_adj_ppm < -500) freq_adj_ppm = -500;
    
    // åº”ç”¨åˆ°ç¡¬ä»¶æ—¶é’Ÿ
    apply_clock_adjustment(freq_adj_ppm);
}
```

---

## ðŸ”Œ API æŽ¥å£å®šä¹‰

### åˆå§‹åŒ–æŽ¥å£

```c
/**
 * åˆå§‹åŒ– PTP åè®®æ ˆ
 * @param role: PTP_MASTER (1) æˆ– PTP_SLAVE (0)
 * @param domain: PTP åŸŸå· (0-127, é»˜è®¤ 0)
 * @param config: é…ç½®ç»“æž„æŒ‡é’ˆ
 * @return: æˆåŠŸè¿”å›ž PTP å¥æŸ„, å¤±è´¥è¿”å›ž NULL
 */
ptp_handle_t ptp_init(uint8_t role, uint8_t domain, 
                      const ptp_config_t *config);

/**
 * ååˆå§‹åŒ–, é‡Šæ”¾èµ„æº
 * @param handle: PTP å¥æŸ„
 */
void ptp_deinit(ptp_handle_t handle);
```

### ä¸»å¾ªçŽ¯æŽ¥å£

```c
/**
 * PTP åè®®æ ˆä¸»å¾ªçŽ¯, éœ€å‘¨æœŸæ€§è°ƒç”¨ (å»ºè®® 1ms)
 * @param handle: PTP å¥æŸ„
 * @return: 0 æˆåŠŸ, éž 0 è¡¨ç¤ºé”™è¯¯
 */
int ptp_step(ptp_handle_t handle);

/**
 * å¤„ç†æ”¶åˆ°çš„ç½‘ç»œæ•°æ®åŒ…
 * @param handle: PTP å¥æŸ„
 * @param data: æŽ¥æ”¶çš„æ•°æ®æŒ‡é’ˆ
 * @param length: æ•°æ®é•¿åº¦
 * @param hw_timestamp: ç¡¬ä»¶æ—¶é—´æˆ³ (nanoseconds)
 * @return: 0 æˆåŠŸå¤„ç†, -1 è¡¨ç¤ºæ— æ•ˆæ•°æ®
 */
int ptp_process_packet(ptp_handle_t handle, const uint8_t *data,
                       uint16_t length, uint64_t hw_timestamp);
```

### çŠ¶æ€æŸ¥è¯¢æŽ¥å£

```c
/**
 * èŽ·å–å½“å‰æ—¶é—´ (synchronized time)
 * @param handle: PTP å¥æŸ„
 * @param time_ns: è¾“å‡ºæŒ‡é’ˆ, æŽ¥æ”¶æ—¶é—´å€¼ (nanoseconds)
 * @return: 0 æˆåŠŸ, -1 è¡¨ç¤ºæœªåŒæ­¥
 */
int ptp_get_time(ptp_handle_t handle, uint64_t *time_ns);

/**
 * èŽ·å–åŒæ­¥ç»Ÿè®¡ä¿¡æ¯
 * @param handle: PTP å¥æŸ„
 * @param stats: è¾“å‡ºæŒ‡é’ˆ, æŽ¥æ”¶ç»Ÿè®¡æ•°æ®
 * @return: 0 æˆåŠŸ
 */
int ptp_get_stats(ptp_handle_t handle, ptp_stats_t *stats);

/**
 * æŸ¥è¯¢åŒæ­¥çŠ¶æ€
 * @param handle: PTP å¥æŸ„
 * @return: 0=æœªåŒæ­¥, 1=åŒæ­¥ä¸­, 2=å·²åŒæ­¥
 */
uint8_t ptp_get_sync_status(ptp_handle_t handle);

/**
 * èŽ·å–æœ€åŽåŒæ­¥è¯¯å·® (nanoseconds)
 * @param handle: PTP å¥æŸ„
 * @return: æœ€åŽæµ‹é‡çš„æ—¶é—´è¯¯å·®
 */
int64_t ptp_get_last_sync_error(ptp_handle_t handle);
```

---

## ðŸ”§ å¹³å°é€‚é…å±‚

### ç¡¬ä»¶æ—¶é—´æˆ³é©±åŠ¨æŽ¥å£

æ¯ä¸ªå¹³å°éœ€å®žçŽ°ä»¥ä¸‹æŽ¥å£ï¼š

```c
// å¹³å°ç‰¹å®šçš„åˆå§‹åŒ–
int platform_timestamp_init(void);

// èŽ·å–å½“å‰ç¡¬ä»¶æ—¶é—´ (nanoseconds, ç»å¯¹æ—¶é—´)
uint64_t platform_get_timestamp(void);

// è°ƒæ•´ç¡¬ä»¶æ—¶é’Ÿé¢‘çŽ‡ (PPM: -500 ~ +500)
int platform_adjust_clock(int32_t ppm);

// è®¾ç½®ç¡¬ä»¶æ—¶é’Ÿ (ä»…åœ¨åˆå§‹åŒ–æ—¶ä½¿ç”¨)
int platform_set_time(uint64_t time_ns);
```

### å¹³å°å®žçŽ°æ¸…å•

#### STM32H7
- ä½¿ç”¨å†…éƒ¨è®¡æ—¶å™¨ (TIM7) æä¾›é«˜ç²¾åº¦æ—¶é—´æˆ³
- ä»¥å¤ªç½‘ DMA æ•èŽ·æŠ¥æ–‡æŽ¥æ”¶æ—¶é—´
- é¢‘çŽ‡è°ƒæ•´é€šè¿‡æ”¹å˜å®šæ—¶å™¨é¢„åˆ†é¢‘

#### RK3588
- ä½¿ç”¨ CLOCKSOURCE_ACPI_PM (ARM é€šç”¨è®¡æ—¶å™¨)
- ä»Žç½‘å¡é©±åŠ¨èŽ·å–ç¡¬ä»¶æ—¶é—´æˆ³ (å¦‚æžœæ”¯æŒ)
- é€šè¿‡è°ƒæ•´ PLL é¢‘çŽ‡å®žçŽ° Servo

#### ESP32
- ä½¿ç”¨ CPU å†…éƒ¨è®¡æ—¶å™¨ (Timer Group 0)
- ä»¥å¤ªç½‘æŽ¥æ”¶ä¸­æ–­è®°å½•æ—¶é—´æˆ³
- é€šè¿‡ XTAL åˆ†é¢‘å®žçŽ°é¢‘çŽ‡è°ƒæ•´

---

## ðŸ“Š æ€§èƒ½ç›®æ ‡

| æŒ‡æ ‡ | ç›®æ ‡ | æµ‹è¯•æ–¹æ³• |
|------|------|---------|
| åŒæ­¥ç²¾åº¦ | <10Âµs | ä¸Ž GPS å‚è€ƒä¿¡å·å¯¹æ¯” |
| æ”¶æ•›æ—¶é—´ | <10s | ä»Žå¯åŠ¨åˆ° <1Âµs è¯¯å·® |
| æ¶ˆæ¯å¤„ç†å»¶è¿Ÿ | <100Âµs | æµ‹é‡ SYNC æ”¶åˆ°åˆ° PI Servo è°ƒæ•´ |
| CPU å ç”¨çŽ‡ | <5% | åœ¨ 100MHz MCU ä¸Š |
| å†…å­˜å ç”¨ | <256KB | å † + æ ˆ + å…¨å±€å˜é‡ |

---

## ðŸ§ª æµ‹è¯•ç­–ç•¥

### å•å…ƒæµ‹è¯•
- æ¶ˆæ¯ç¼–è§£ç æµ‹è¯•
- çŠ¶æ€æœºè½¬ç§»æµ‹è¯•
- Servo ç®—æ³•æµ‹è¯•
- æ—¶é—´è®¡ç®—ç²¾åº¦æµ‹è¯•

### é›†æˆæµ‹è¯•
- Master-Slave åŒæ­¥æµ‹è¯•
- å¤š Slave å¹¶å‘æµ‹è¯•
- ç½‘ç»œå»¶è¿Ÿå˜åŒ–é€‚åº”æ€§æµ‹è¯•
- é•¿æœŸç¨³å®šæ€§æµ‹è¯• (24h+)

### æ€§èƒ½æµ‹è¯•
- ç²¾åº¦æµ‹é‡ (å¯¹æ ‡ GPS/é«˜ç²¾åº¦å‚è€ƒ)
- å»¶è¿Ÿåˆ†æž (ä½¿ç”¨ç¤ºæ³¢å™¨æˆ–é€»è¾‘åˆ†æžä»ª)
- æŠ–åŠ¨ (Jitter) æµ‹é‡
- èƒ½è€—åˆ†æž

---

## ðŸ“… å¼€å‘é‡Œç¨‹ç¢‘

| å‘¨ | ä»»åŠ¡ | äº¤ä»˜ç‰© |
|----|------|--------|
| W1-W2 | æž¶æž„è®¾è®¡ + API å®šä¹‰ | æœ¬æ–‡æ¡£ + å¤´æ–‡ä»¶ |
| W3-W4 | æž¶æž„è¯„å®¡ | æž¶æž„è¯„å®¡è®°å½• |
| W5-W7 | Master å®žçŽ° | Master æ¶ˆæ¯å¤„ç†ä»£ç  |
| W8-W9 | Slave + Servo å®žçŽ° | Slave åŒæ­¥ä»£ç  |
| W10 | PI Servo ä¼˜åŒ– | ç²¾åº¦ä¼˜åŒ–æŠ¥å‘Š |
| W11-W14 | è·¨å¹³å°é€‚é… | 3 ä¸ªå¹³å°é©±åŠ¨å®Œæˆ |
| W15-W16 | é›†æˆéªŒè¯ | é›†æˆæµ‹è¯•æŠ¥å‘Š |
| W17-W20 | æ–‡æ¡£å®Œå–„ | å®Œæ•´ API æ–‡æ¡£ |

---

## âœ… è®¾è®¡è¯„å®¡æ¸…å•

- [ ] API æŽ¥å£çš„å®Œæ•´æ€§å’Œæ˜“ç”¨æ€§
- [ ] çŠ¶æ€æœºçš„å¥å£®æ€§ (æ— æ­»é”ã€æ— æ— é™å¾ªçŽ¯)
- [ ] å†…å­˜å’Œ CPU ä½¿ç”¨æ˜¯å¦åœ¨é¢„æœŸèŒƒå›´
- [ ] ç¡¬ä»¶æ—¶é—´æˆ³æŽ¥å£çš„é€šç”¨æ€§
- [ ] é”™è¯¯å¤„ç†çš„å……åˆ†æ€§
- [ ] ä»£ç æ³¨é‡Šçš„å®Œæ•´æ€§

---

**ä¸‹ä¸€æ­¥**: ç­‰å¾…æž¶æž„è¯„å®¡ï¼Œè®¡åˆ’ 2026å¹´2æœˆ2æ—¥å®Œæˆè¯„å®¡å¹¶å¯åŠ¨ç¼–ç ã€‚
