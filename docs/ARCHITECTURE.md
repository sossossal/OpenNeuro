# OpenNeuro 架构设计文档

## 概述

OpenNeuro 采用分层架构设计，将机器人系统划分为五个层次，从上到下分别为：应用层、中间件层、协议层、网络层和硬件层。

```
┌─────────────────────────────────────────┐
│   应用层 (Application Layer)             │
│   ROS 2 应用 / 用户自定义算法             │
└────────────────┬────────────────────────┘
                 │
┌────────────────▼────────────────────────┐
│   中间件层 (Middleware Layer)             │
│   Eclipse Zenoh (ROS 2 rmw_zenoh)       │
└────────────────┬────────────────────────┘
                 │
┌────────────────▼────────────────────────┐
│   协议层 (Protocol Layer)                │
│   Zenoh-Pico / Zenoh Router / Z Protocol│
└────────────────┬────────────────────────┘
                 │
┌────────────────▼────────────────────────┐
│   网络层 (Network Layer)                 │
│   TCP/UDP/Ethernet + TSN + PTP (future) │
└────────────────┬────────────────────────┘
                 │
┌────────────────▼────────────────────────┐
│   硬件层 (Hardware Layer)                │
│   Cortex / Ganglion / Neuron            │
└─────────────────────────────────────────┘
```

---

## 角色定义

### 1. Cortex（大脑节点）

**硬件**：
- 高性能 PC 或 NVIDIA Jetson 系列
- 多核 CPU，充足内存（8GB+）

**软件栈**：
```
┌──────────────────────────────┐
│  ROS 2 应用层                 │
│  (视觉 / 规划 / 大模型)        │
├──────────────────────────────┤
│  rmw_zenoh (ROS 2 中间件)     │
├──────────────────────────────┤
│  Zenoh Router / C++ Client    │
├──────────────────────────────┤
│  Linux 内核 (TCP/IP stack)    │
├──────────────────────────────┤
│  Ethernet / WiFi 硬件         │
└──────────────────────────────┘
```

**职责**：
- 运行高计算量任务（视觉识别、路径规划）
- 管理全局状态和决策
- 与 Ganglion 协调控制指令

---

### 2. Ganglion（神经节/区域网关）

**硬件**：
- ARM SoC：RK3588、i.MX 8、树莓派 5 等
- 运行完整 Linux / 实时操作系统
- 网络接口：1x Gigabit Ethernet、多个 I2C/SPI 接口

**软件栈**：
```
┌──────────────────────────────┐
│  Zenoh Router（核心）         │
│  TSN 流量调度器              │
│  本地控制逻辑                │
├──────────────────────────────┤
│  POSIX 网络 API               │
├──────────────────────────────┤
│  Linux 内核 + 实时补丁       │
├──────────────────────────────┤
│  Ethernet + I2C/SPI 控制器   │
└──────────────────────────────┘
```

**职责**：
- 汇聚一个肢体（如手臂）的所有 Neuron 数据
- 为该肢体的实时控制提供本地协调
- 实现故障隔离（一个 Ganglion 故障不影响其他肢体）
- 可选：实现 TSN 调度，确保硬实时性

---

### 3. Neuron（神经元/末端执行器）

**硬件**：
- MCU：STM32H7、ESP32-S3、i.MX RT 等
- RAM 不少于 256KB，Flash 512KB+
- 集成 ADC、PWM、CAN/Modbus 接口

**软件栈**：
```
┌──────────────────────────────┐
│  驱动应用层                  │
│  (电机控制 / 传感器读取)      │
├──────────────────────────────┤
│  Zenoh-Pico 客户端           │
├──────────────────────────────┤
│  轻量级 RTOS                 │
│  (FreeRTOS / Zephyr)         │
├──────────────────────────────┤
│  硬件驱动 (SPI/I2C/UART)     │
├──────────────────────────────┤
│  MCU 硬件                    │
└──────────────────────────────┘
```

**职责**：
- 执行 Ganglion 的控制指令
- 采集传感器数据（关节角度、力传感器等）
- 本地实时反应（如应急停止）
- 通过 PTP 进行时间同步（阶段二）

---

## 数据流设计

### 方向 1：远程命令（Cortex → Neuron）

```
用户ROS 2 代码
    │
    ▼
/robot/arm/joint_target (Topic)
    │
    ▼
rmw_zenoh (Zenoh 序列化/反序列化)
    │
    ▼
Zenoh Router (路由转发)
    │
    ├─→ Ganglion 1 (Zenoh Router)
    │       │
    │       ▼
    │   rt/arm_1/joint_cmd (Zenoh 消息)
    │       │
    │       ▼
    │   Neuron 1 (Zenoh-Pico)
    │       │
    │       ▼
    │   电机驱动 → 舵机旋转
    │
    └─→ Ganglion 2 (Zenoh Router)
            ...
```

**延迟预期**：
- 序列化：<0.1ms
- Zenoh 路由：<0.5ms
- 网络传输：0.5-1.5ms（WiFi）
- MCU 处理：<0.1ms
- **总计**：<2.3ms（阶段一目标）

### 方向 2：传感器反馈（Neuron → Cortex）

```
传感器读取 (ADC/GPIO)
    │
    ▼
Zenoh-Pico 发布
    │
    ▼
Zenoh Router
    │
    ▼
rmw_zenoh 反序列化
    │
    ▼
ROS 2 Topic (/robot/joint/state)
    │
    ▼
用户 ROS 2 回调
```

---

## 通信协议选择

### 为什么选择 Zenoh？

| 特性 | DDS | Micro-ROS | Zenoh-Pico | OpenNeuro 选择 |
|------|-----|-----------|-----------|---------------|
| 自动发现 | ✓ 但易风暴 | ✓ 受限 | ✓✓ 高效 | ✓✓ |
| 编程复杂度 | 复杂 | 中等 | 简单 | ✓✓ |
| 末端 MCU 支持 | ✗ | ✓ | ✓✓ | ✓✓ |
| 零拷贝 | ✓ | ✗ | ✓✓ | ✓✓ |
| 实时性 | ✓ | ✓ | ✓ | ✓ |
| 生态成熟度 | ✓✓✓ | ✓✓ | ✓ | ✓✓ |

---

## Zone Architecture（区域架构）

区域架构的核心思想是**按功能模块划分子网**，而非平坦的全连接。

### 示例：人形机器人拓扑

```
                   ┌─────────────────┐
                   │  Cortex         │
                   │  (主计算节点)    │
                   └────────┬────────┘
                            │
                     Zenoh Router
                            │
          ┌─────────────────┼──────────────────┐
          │                 │                  │
    ┌─────▼────┐    ┌───────▼──────┐  ┌───────▼──────┐
    │ Ganglion │    │  Ganglion    │  │  Ganglion    │
    │  Left    │    │   Right Arm  │  │   Legs       │
    │   Arm    │    │              │  │              │
    └─────┬────┘    └───────┬──────┘  └───────┬──────┘
          │                 │                 │
     ┌────┴────────┐   ┌────┴────────┐  ┌────┴────────┐
     │             │   │             │  │             │
   肩转   肘转   腕转  肩转  肘转   腕转  髋转  膝转  踝转
   (PWM)  (PWM) (PWM) (PWM) (PWM) (PWM)(PWM)(PWM)(PWM)
```

**优势**：
- 故障隔离：左臂故障不影响右臂
- 并行处理：各 Ganglion 独立进行本地控制
- 线束最小化：不需要所有末端直接连接到主节点
- 可扩展：新增一条腿只需新增一个 Ganglion + 若干 Neuron

---

## 时间同步（阶段二）

### PTP（精密时间协议，IEEE 1588）

```
                      ┌──────────────────┐
                      │   Grandmaster     │
                      │   Clock Source    │
                      │   (Cortex PC)     │
                      └────────┬─────────┘
                               │
                   PTP 同步信号 (SYNC + DELAY_REQ)
                               │
          ┌────────────────────┼────────────────────┐
          │                    │                    │
      ┌───▼──┐            ┌───▼──┐            ┌───▼──┐
      │ Gang │            │ Gang │            │ Gang │
      │ lion │            │ lion │            │ lion │
      │  1   │<──PTP──>   │  2   │<──PTP──>   │  3   │
      └───┬──┘            └───┬──┘            └───┬──┘
          │                   │                   │
        Neuron              Neuron              Neuron
          │                   │                   │
      时间戳:            时间戳:              时间戳:
      t=1000µs          t=1001µs             t=999µs
      (同步至<10µs)
```

通过 PTP，所有节点都能感知到全局时间，从而实现：
- 分布式**硬实时控制**
- **协调运动**（多个关节的同步动作）
- **事件时间戳**（精确知道何时发生了什么）

---

## ROS 2 集成

### rmw_zenoh（ROS Middleware for Zenoh）

OpenNeuro 计划通过 ROS 2 的中间件抽象层，将 ROS 2 Topic 直接映射到 Zenoh 资源：

```
ROS 2 应用代码
    │
    ▼
DDS 接口层（虚拟的 rmw_zenoh）
    ├─→ pub(/cmd) ─┐
    │              │ 自动映射
    └─→ sub(/state)─┤
                   │
                   ▼
            Zenoh 资源
            ├─→ rt/robot/cmd
            ├─→ rt/robot/state
            └─→ rt/...
```

**好处**：
- 现有 ROS 2 代码无需改动
- 可以混用 DDS 节点和 Zenoh 节点
- 性能提升（零拷贝、更快的发现）

---

## 可靠性和容错

### 消息可靠性

Zenoh 支持多种 QoS 模式：

1. **Best Effort**：快速但可能丢包（传感器数据）
2. **Reliable**：保证到达，但可能延迟（关键命令）

OpenNeuro 建议：
- **高频传感器数据**（>10Hz）：Best Effort（丢几帧无所谓）
- **控制指令**（<10Hz）：Reliable（必须送达）

### 故障转移

```
主 Ganglion 故障
      │
      ▼
Cortex 检测超时（心跳丢失）
      │
      ▼
触发故障转移策略
      │
      ├─→ 如有备用 Ganglion，切换到备用
      │
      └─→ 紧急停止该肢体
```

---

## 性能建模

### 端到端延迟 (E2E)

$$E2E_{latency} = T_{serialize} + T_{zenoh\_forward} + T_{network} + T_{deserialize} + T_{process}$$

**数值示例**（WiFi 链路）：
- $T_{serialize}$: 0.05ms（ROS 2 消息 → Zenoh）
- $T_{zenoh\_forward}$: 0.3ms（路由转发）
- $T_{network}$: 1.5ms（WiFi 传播）
- $T_{deserialize}$: 0.05ms（Zenoh → 本地处理）
- $T_{process}$: 0.1ms（MCU 执行）
- **总计**：约 2.0ms

---

## 扩展性

### 水平扩展

OpenNeuro 支持以下扩展方式：

1. **增加 Ganglion 数量**：每个新肢体一个
2. **增加 Neuron 数量**：每个肢体可以多达 64 个 MCU（Zenoh 地址空间）
3. **增加传感器**：热插拔新传感器，自动被发现

### 竖直扩展

- **网络升级**：从 WiFi → 有线 Ethernet
- **硬件升级**：从 ESP32 → STM32H7（更强算力）
- **时间精度升级**：从普通时钟 → PTP（<10µs）

---

## 安全考虑（阶段三+）

虽然当前版本不涉及安全，但架构预留了以下扩展点：

1. **消息认证**（MAC）
2. **端到端加密**（TLS over Zenoh）
3. **访问控制列表**（ACL）
4. **审计日志**

---

## 与现有平台的兼容性

| 平台 | 支持情况 | 备注 |
|------|--------|------|
| ROS 2 | ✓✓ | 官方支持 rmw_zenoh |
| Micro-ROS | ✓ | 可作为替代方案 |
| PX4 | ✓ | 固件支持 Zenoh 后端 |
| 传统 ROS | ✗ | ROS 1 EOL，不予支持 |

---

## 参考资源

- [Zenoh 官方文档](https://zenoh.io/docs/)
- [ROS 2 官方文档](https://docs.ros.org/en/jazzy/)
- [IEEE 1588 PTP 规范](https://en.wikipedia.org/wiki/Precision_Time_Protocol)
- [TSN 基础知识](https://en.wikipedia.org/wiki/Time-sensitive_networking)

---

**文档版本**：v0.1.0  
**最后更新**：2026 年 1 月

